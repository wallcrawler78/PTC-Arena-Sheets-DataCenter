<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Google Sans', Arial, sans-serif;
      background: #f5f5f5;
      overflow-x: hidden;
    }

    /* Header */
    .header {
      background: linear-gradient(135deg, #1a73e8 0%, #174ea6 100%);
      color: white;
      padding: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .header h1 {
      font-size: 18px;
      font-weight: 500;
      margin-bottom: 4px;
    }

    .header p {
      font-size: 12px;
      opacity: 0.9;
    }

    /* Controls */
    .controls {
      background: white;
      padding: 16px;
      border-bottom: 1px solid #dadce0;
    }

    .control-group {
      margin-bottom: 12px;
    }

    .control-group:last-child {
      margin-bottom: 0;
    }

    .control-group label {
      display: block;
      font-size: 12px;
      color: #5f6368;
      margin-bottom: 4px;
      font-weight: 500;
    }

    select, input[type="text"] {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #dadce0;
      border-radius: 4px;
      font-size: 14px;
      background: white;
      transition: border-color 0.2s;
    }

    select:focus, input[type="text"]:focus {
      outline: none;
      border-color: #1a73e8;
      box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.1);
    }

    .search-box {
      position: relative;
    }

    .search-box input {
      padding-right: 36px;
    }

    .search-icon {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      color: #5f6368;
      pointer-events: none;
    }

    /* Category Pills */
    .category-pills {
      background: white;
      padding: 12px 16px;
      border-bottom: 1px solid #dadce0;
      display: flex;
      gap: 8px;
      overflow-x: auto;
      white-space: nowrap;
    }

    .category-pills::-webkit-scrollbar {
      height: 4px;
    }

    .category-pills::-webkit-scrollbar-thumb {
      background: #dadce0;
      border-radius: 2px;
    }

    .category-pill {
      padding: 6px 14px;
      border-radius: 16px;
      font-size: 13px;
      cursor: pointer;
      border: 1px solid #dadce0;
      background: white;
      transition: all 0.2s;
      flex-shrink: 0;
    }

    .category-pill:hover {
      border-color: #1a73e8;
      background: #e8f0fe;
    }

    .category-pill.active {
      background: #1a73e8;
      color: white;
      border-color: #1a73e8;
    }

    /* Items List */
    .items-container {
      height: calc(100vh - 300px);
      overflow-y: auto;
      padding: 16px;
    }

    .item-card {
      background: white;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.12);
      cursor: pointer;
      transition: all 0.2s;
      border-left: 4px solid transparent;
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .item-card:hover {
      box-shadow: 0 4px 8px rgba(0,0,0,0.16);
      transform: translateY(-2px);
    }

    .item-card.selected {
      border-left-color: #1a73e8;
      background: #e8f0fe;
    }

    .item-number {
      font-weight: 600;
      font-size: 14px;
      color: #202124;
      margin-bottom: 4px;
    }

    .item-description {
      font-size: 13px;
      color: #5f6368;
      margin-bottom: 8px;
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
    }

    .item-meta {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .item-badge {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 12px;
      background: #f1f3f4;
      color: #5f6368;
    }

    .item-badge.lifecycle {
      background: #e6f4ea;
      color: #137333;
    }

    .item-badge.revision {
      background: #fce8e6;
      color: #c5221f;
    }

    /* Loading & Empty States */
    .loading, .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #5f6368;
    }

    .loading-spinner {
      border: 3px solid #f1f3f4;
      border-top: 3px solid #1a73e8;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .empty-state svg {
      width: 80px;
      height: 80px;
      margin-bottom: 16px;
      opacity: 0.3;
    }

    /* Insert Button */
    .insert-button {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #1a73e8;
      color: white;
      border: none;
      border-radius: 50%;
      width: 56px;
      height: 56px;
      font-size: 24px;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      transition: all 0.2s;
      display: none;
    }

    .insert-button:hover {
      background: #1765cc;
      box-shadow: 0 6px 12px rgba(0,0,0,0.3);
      transform: scale(1.05);
    }

    .insert-button.visible {
      display: block;
      animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: scale(0.8);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    /* Toast Notification */
    .toast {
      position: fixed;
      bottom: 90px;
      left: 50%;
      transform: translateX(-50%);
      background: #202124;
      color: white;
      padding: 12px 24px;
      border-radius: 24px;
      font-size: 14px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
    }

    .toast.visible {
      opacity: 1;
    }

    .toast.success {
      background: #137333;
    }

    .toast.error {
      background: #c5221f;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <h1>Arena Item Browser</h1>
    <p>Select items to add to your datacenter layout</p>
  </div>

  <!-- Controls -->
  <div class="controls">
    <div class="control-group">
      <label for="lifecycleFilter">Lifecycle Phase</label>
      <select id="lifecycleFilter" onchange="loadItems()">
        <option value="Production">Production</option>
        <option value="Prototype">Prototype</option>
        <option value="Engineering">Engineering</option>
        <option value="Pre-Production">Pre-Production</option>
        <option value="Obsolete">Obsolete</option>
        <option value="All">All Lifecycles</option>
      </select>
    </div>

    <div class="control-group">
      <label for="searchBox">Search Items</label>
      <div class="search-box">
        <input type="text" id="searchBox" placeholder="Search by item number or description...">
        <span class="search-icon">üîç</span>
      </div>
    </div>
  </div>

  <!-- Category Pills -->
  <div class="category-pills" id="categoryPills"></div>

  <!-- Items List -->
  <div class="items-container" id="itemsContainer">
    <div class="loading">
      <div class="loading-spinner"></div>
      <p>Loading categories...</p>
    </div>
  </div>

  <!-- Insert Button -->
  <button class="insert-button" id="insertButton" onclick="insertSelectedItem()">+</button>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <script>
    let categories = [];
    let currentCategory = null;
    let items = [];
    let selectedItem = null;
    let categoryColors = {};
    let searchTimeout = null;

    // Load initial data
    window.onload = function() {
      loadCategoryColors();
      loadCategories();

      // Setup search with debounce
      document.getElementById('searchBox').addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          if (this.value.trim().length > 0) {
            searchItems();
          } else if (currentCategory) {
            loadItems();
          }
        }, 300);
      });
    };

    function loadCategoryColors() {
      google.script.run
        .withSuccessHandler(function(colors) {
          categoryColors = colors;
        })
        .getCategoryColors();
    }

    function loadCategories() {
      google.script.run
        .withSuccessHandler(function(cats) {
          categories = cats;
          renderCategoryPills();
          if (categories.length > 0) {
            selectCategory(categories[0].name);
          }
        })
        .withFailureHandler(function(error) {
          showToast('Error loading categories: ' + error.message, 'error');
        })
        .getCategories();
    }

    function renderCategoryPills() {
      const container = document.getElementById('categoryPills');
      container.innerHTML = '';

      categories.forEach(cat => {
        const pill = document.createElement('div');
        pill.className = 'category-pill';
        pill.textContent = cat.name;
        pill.onclick = () => selectCategory(cat.name);

        // Apply category color as background
        if (categoryColors[cat.name]) {
          pill.style.backgroundColor = categoryColors[cat.name];
          pill.style.borderColor = categoryColors[cat.name];
        }

        container.appendChild(pill);
      });
    }

    function selectCategory(categoryName) {
      currentCategory = categoryName;
      document.getElementById('searchBox').value = '';

      // Update active state
      document.querySelectorAll('.category-pill').forEach(pill => {
        if (pill.textContent === categoryName) {
          pill.classList.add('active');
        } else {
          pill.classList.remove('active');
        }
      });

      loadItems();
    }

    function loadItems() {
      if (!currentCategory) return;

      const lifecycle = document.getElementById('lifecycleFilter').value;
      const container = document.getElementById('itemsContainer');

      container.innerHTML = '<div class="loading"><div class="loading-spinner"></div><p>Loading items...</p></div>';

      google.script.run
        .withSuccessHandler(function(itemsList) {
          items = itemsList;
          renderItems();
        })
        .withFailureHandler(function(error) {
          container.innerHTML = '<div class="empty-state"><p>Error loading items: ' + error.message + '</p></div>';
        })
        .getItemsByCategory(currentCategory, lifecycle);
    }

    function searchItems() {
      const query = document.getElementById('searchBox').value.trim();
      if (query.length === 0) return;

      const lifecycle = document.getElementById('lifecycleFilter').value;
      const container = document.getElementById('itemsContainer');

      container.innerHTML = '<div class="loading"><div class="loading-spinner"></div><p>Searching...</p></div>';

      google.script.run
        .withSuccessHandler(function(itemsList) {
          items = itemsList;
          renderItems();
        })
        .withFailureHandler(function(error) {
          container.innerHTML = '<div class="empty-state"><p>Error searching: ' + error.message + '</p></div>';
        })
        .searchItems(query, lifecycle);
    }

    function renderItems() {
      const container = document.getElementById('itemsContainer');

      if (items.length === 0) {
        container.innerHTML = '<div class="empty-state"><p>No items found</p></div>';
        return;
      }

      container.innerHTML = '';

      items.forEach(item => {
        const card = document.createElement('div');
        card.className = 'item-card';
        card.onclick = () => selectItem(item, card);

        // Apply category color
        if (item.category && categoryColors[item.category]) {
          card.style.borderLeftColor = categoryColors[item.category];
        }

        card.innerHTML = `
          <div class="item-number">${item.number}</div>
          <div class="item-description">${item.description || 'No description'}</div>
          <div class="item-meta">
            <span class="item-badge lifecycle">${item.lifecyclePhase}</span>
            ${item.revisionNumber ? '<span class="item-badge revision">Rev ' + item.revisionNumber + '</span>' : ''}
            ${item.category ? '<span class="item-badge">' + item.category + '</span>' : ''}
          </div>
        `;

        container.appendChild(card);
      });
    }

    function selectItem(item, cardElement) {
      selectedItem = item;

      // Update visual selection
      document.querySelectorAll('.item-card').forEach(card => {
        card.classList.remove('selected');
      });
      cardElement.classList.add('selected');

      // Show insert button
      const insertButton = document.getElementById('insertButton');
      insertButton.classList.add('visible');

      showToast('Item selected. Click a cell in the sheet to insert, or click the + button.');
    }

    function insertSelectedItem() {
      if (!selectedItem) {
        showToast('Please select an item first', 'error');
        return;
      }

      // Get the active cell
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showToast('Item inserted successfully!', 'success');
            selectedItem = null;
            document.getElementById('insertButton').classList.remove('visible');
            document.querySelectorAll('.item-card').forEach(card => {
              card.classList.remove('selected');
            });
          } else {
            showToast(result.message, 'error');
          }
        })
        .withFailureHandler(function(error) {
          showToast('Error: ' + error.message, 'error');
        })
        .insertItemAtActiveCell(selectedItem.number);
    }

    function showToast(message, type = 'info') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = 'toast visible ' + type;

      setTimeout(() => {
        toast.className = 'toast';
      }, 3000);
    }

    // Listen for cell clicks to insert items
    window.addEventListener('message', function(event) {
      if (event.data.action === 'cellClicked' && selectedItem) {
        insertSelectedItem();
      }
    });
  </script>
</body>
</html>
