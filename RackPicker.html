<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <!-- SVG Icon Definitions -->
  <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <!-- Server/Rack Icon -->
      <symbol id="icon-server" viewBox="0 0 24 24">
        <path fill="currentColor" d="M4,1H20A1,1 0 0,1 21,2V6A1,1 0 0,1 20,7H4A1,1 0 0,1 3,6V2A1,1 0 0,1 4,1M4,9H20A1,1 0 0,1 21,10V14A1,1 0 0,1 20,15H4A1,1 0 0,1 3,14V10A1,1 0 0,1 4,9M4,17H20A1,1 0 0,1 21,18V22A1,1 0 0,1 20,23H4A1,1 0 0,1 3,22V18A1,1 0 0,1 4,17M9,5H10V3H9V5M9,13H10V11H9V13M9,21H10V19H9V21M5,3V5H7V3H5M5,11V13H7V11H5M5,19V21H7V19H5Z"/>
      </symbol>

      <!-- Globe Icon -->
      <symbol id="icon-globe" viewBox="0 0 24 24">
        <path fill="currentColor" d="M17.9,17.39C17.64,16.59 16.89,16 16,16H15V13A1,1 0 0,0 14,12H8V10H10A1,1 0 0,0 11,9V7H13A2,2 0 0,0 15,5V4.59C17.93,5.77 20,8.64 20,12C20,14.08 19.2,15.97 17.9,17.39M11,19.93C7.05,19.44 4,16.08 4,12C4,11.38 4.08,10.78 4.21,10.21L9,15V16A2,2 0 0,0 11,18M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z"/>
      </symbol>

      <!-- Chart/Bar Chart Icon -->
      <symbol id="icon-chart" viewBox="0 0 24 24">
        <path fill="currentColor" d="M22,21H2V3H4V19H6V10H10V19H12V6H16V19H18V14H22V21Z"/>
      </symbol>

      <!-- Help/Question Icon -->
      <symbol id="icon-help" viewBox="0 0 24 24">
        <path fill="currentColor" d="M10,19H13V22H10V19M12,2C17.35,2.22 19.68,7.62 16.5,11.67C15.67,12.67 14.33,13.33 13.67,14.17C13,15 13,16 13,17H10C10,15.33 10,13.92 10.67,12.92C11.33,11.92 12.67,11.33 13.5,10.67C15.92,8.43 15.32,5.26 12,5A3,3 0 0,0 9,8H6A6,6 0 0,1 12,2Z"/>
      </symbol>

      <!-- Package Icon -->
      <symbol id="icon-package" viewBox="0 0 24 24">
        <path fill="currentColor" d="M21,16.5C21,16.88 20.79,17.21 20.47,17.38L12.57,21.82C12.41,21.94 12.21,22 12,22C11.79,22 11.59,21.94 11.43,21.82L3.53,17.38C3.21,17.21 3,16.88 3,16.5V7.5C3,7.12 3.21,6.79 3.53,6.62L11.43,2.18C11.59,2.06 11.79,2 12,2C12.21,2 12.41,2.06 12.57,2.18L20.47,6.62C20.79,6.79 21,7.12 21,7.5V16.5M12,4.15L6.04,7.5L12,10.85L17.96,7.5L12,4.15M5,15.91L11,19.29V12.58L5,9.21V15.91M19,15.91V9.21L13,12.58V19.29L19,15.91Z"/>
      </symbol>

      <!-- Document Icon -->
      <symbol id="icon-document" viewBox="0 0 24 24">
        <path fill="currentColor" d="M19,3H5C3.89,3 3,3.89 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5C21,3.89 20.1,3 19,3M9,7H11V9H9V7M15,17H9V15H15V17M17,13H9V11H17V13M17,9H13V7H17V9Z"/>
      </symbol>

      <!-- Refresh Icon -->
      <symbol id="icon-refresh" viewBox="0 0 24 24">
        <path fill="currentColor" d="M17.65,6.35C16.2,4.9 14.21,4 12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20C15.73,20 18.84,17.45 19.73,14H17.65C16.83,16.33 14.61,18 12,18A6,6 0 0,1 6,12A6,6 0 0,1 12,6C13.66,6 15.14,6.69 16.22,7.78L13,11H20V4L17.65,6.35Z"/>
      </symbol>

      <!-- Pencil/Edit Icon -->
      <symbol id="icon-pencil" viewBox="0 0 24 24">
        <path fill="currentColor" d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.12,5.12L18.87,8.87M3,17.25V21H6.75L17.81,9.93L14.06,6.18L3,17.25Z"/>
      </symbol>

      <!-- Clone/Copy Icon -->
      <symbol id="icon-clone" viewBox="0 0 24 24">
        <path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/>
      </symbol>

      <!-- Template Icon -->
      <symbol id="icon-template" viewBox="0 0 24 24">
        <path fill="currentColor" d="M18,6H20V9H18V6M11,6H13V9H11V6M4,6H6V9H4V6M18,11H20V14H18V11M11,11H13V14H11V11M4,11H6V14H4V11M18,16H20V19H18V16M11,16H13V19H11V16M4,16H6V19H4V16M3,22H21V2H3V22M5,4H19V20H5V4Z"/>
      </symbol>

      <!-- Star Icon (for favorites) -->
      <symbol id="icon-star" viewBox="0 0 24 24">
        <path fill="currentColor" d="M12,17.27L18.18,21L16.54,13.97L22,9.24L14.81,8.62L12,2L9.19,8.62L2,9.24L7.45,13.97L5.82,21L12,17.27Z"/>
      </symbol>

      <!-- Star Outline Icon (for non-favorited) -->
      <symbol id="icon-star-outline" viewBox="0 0 24 24">
        <path fill="currentColor" d="M12,15.39L8.24,17.66L9.23,13.38L5.91,10.5L10.29,10.13L12,6.09L13.71,10.13L18.09,10.5L14.77,13.38L15.76,17.66M22,9.24L14.81,8.63L12,2L9.19,8.63L2,9.24L7.45,13.97L5.82,21L12,17.27L18.18,21L16.54,13.97L22,9.24Z"/>
      </symbol>
    </defs>
  </svg>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    /* SVG Icon Utilities */
    .icon {
      display: inline-block;
      width: 18px;
      height: 18px;
      vertical-align: middle;
    }

    .icon-sm {
      width: 14px;
      height: 14px;
    }

    .icon-md {
      width: 18px;
      height: 18px;
    }

    .icon-lg {
      width: 24px;
      height: 24px;
    }

    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      height: 100vh;
      overflow: hidden;
    }

    .sidebar {
      display: flex;
      flex-direction: column;
      height: 100vh;
      background: white;
    }

    .header {
      background: linear-gradient(135deg, #1a73e8 0%, #1557b0 100%);
      color: white;
      padding: 12px 15px;
      border-bottom: 1px solid #e0e0e0;
    }

    .header h2 {
      font-size: 16px;
      font-weight: bold;
      margin-bottom: 2px;
    }

    .header p {
      font-size: 11px;
      opacity: 0.9;
    }

    /* Tab Navigation */
    .tab-nav {
      display: flex;
      background: #f9f9f9;
      border-bottom: 2px solid #e0e0e0;
    }

    .tab-button {
      flex: 1;
      padding: 12px 16px;
      border: none;
      background: none;
      font-size: 13px;
      font-weight: 500;
      color: #666;
      cursor: pointer;
      transition: all 0.2s;
      border-bottom: 3px solid transparent;
    }

    .tab-button:hover {
      background: #f1f3f4;
      color: #333;
    }

    .tab-button.active {
      color: #1a73e8;
      background: white;
      border-bottom-color: #1a73e8;
    }

    .tab-content {
      display: none;
      flex: 1;
      flex-direction: column;
      overflow: hidden;
    }

    .tab-content.active {
      display: flex;
    }

    /* Racks Tab Styles */
    .content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .info-box {
      background: #e8f0fe;
      border-left: 3px solid #1a73e8;
      padding: 12px;
      margin: 12px 15px;
      border-radius: 4px;
      font-size: 12px;
      color: #174ea6;
    }

    .search-box {
      margin: 0 15px 12px 15px;
      position: relative;
    }

    .search-box input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #dadce0;
      border-radius: 4px;
      font-size: 12px;
      box-sizing: border-box;
    }

    .search-box input:focus {
      outline: none;
      border-color: #1a73e8;
      box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.1);
    }

    .search-with-button {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .search-with-button input {
      flex: 1;
    }

    .search-button {
      padding: 8px 16px;
      background: linear-gradient(135deg, #1a73e8 0%, #174ea6 100%);
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .search-button:hover:not(:disabled) {
      box-shadow: 0 2px 4px rgba(26, 115, 232, 0.3);
      transform: translateY(-1px);
    }

    .search-button:active:not(:disabled) {
      transform: translateY(0);
    }

    .search-button:disabled {
      background: #e0e0e0;
      color: #999;
      cursor: not-allowed;
    }

    .search-spinner {
      border: 2px solid #ffffff40;
      border-top: 2px solid #ffffff;
      border-radius: 50%;
      width: 12px;
      height: 12px;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .favorites-toggle {
      margin: 0 15px 12px 15px;
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .favorites-btn {
      padding: 6px 12px;
      border: 1px solid #dadce0;
      background: white;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .favorites-btn:hover {
      border-color: #1a73e8;
      background: #f8f9fa;
    }

    .favorites-btn.active {
      background: #e8f0fe;
      border-color: #1a73e8;
      color: #1a73e8;
      font-weight: 500;
    }

    .favorite-star {
      cursor: pointer;
      color: #dadce0;
      transition: all 0.2s;
    }

    .favorite-star:hover {
      color: #fbbc04;
      transform: scale(1.2);
    }

    .favorite-star.favorited {
      color: #fbbc04;
    }

    .component-checkbox-item {
      padding: 8px 12px;
      border-bottom: 1px solid #f0f0f0;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .component-checkbox-item:hover {
      background: #f8f9fa;
    }

    .component-checkbox-item:last-child {
      border-bottom: none;
    }

    .component-checkbox-item input[type="checkbox"] {
      cursor: pointer;
    }

    .component-checkbox-label {
      flex: 1;
      font-size: 12px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .component-checkbox-label .item-number {
      font-weight: 500;
      color: #202124;
    }

    .component-checkbox-label .item-name {
      color: #5f6368;
      font-size: 11px;
    }

    .component-checkbox-label .item-qty {
      color: #1a73e8;
      font-size: 11px;
      font-weight: 500;
    }

    .rack-list {
      flex: 1;
      overflow-y: auto;
      padding: 0 15px 70px 15px; /* Extra padding for button */
    }

    .rack-item {
      padding: 12px;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.2s;
      background: white;
      position: relative;
    }

    .rack-item-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }

    .rack-item-content {
      flex: 1;
    }

    .rack-item-actions {
      display: flex;
      gap: 4px;
      margin-left: 8px;
    }

    .rack-action-btn {
      padding: 4px;
      background: none;
      border: none;
      cursor: pointer;
      color: #5f6368;
      transition: all 0.2s;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .rack-action-btn:hover {
      background: #f1f3f4;
      color: #1a73e8;
    }

    .rack-action-btn svg {
      width: 16px;
      height: 16px;
    }

    .rack-item:hover {
      border-color: #1a73e8;
      box-shadow: 0 2px 8px rgba(26, 115, 232, 0.15);
    }

    .rack-item.selected {
      background-color: #e8f0fe;
      border-color: #1a73e8;
    }

    .rack-number {
      font-weight: bold;
      color: #1a73e8;
      font-size: 14px;
      margin-bottom: 4px;
    }

    .rack-name {
      font-size: 12px;
      color: #333;
      margin-bottom: 2px;
    }

    .rack-description {
      font-size: 11px;
      color: #80868b;
      margin-bottom: 4px;
    }

    .rack-stats {
      font-size: 11px;
      color: #80868b;
      margin-top: 4px;
      display: flex;
      gap: 12px;
    }

    .insert-button {
      position: fixed;
      bottom: 16px;
      left: 16px;
      right: 16px;
      padding: 12px 24px;
      background: linear-gradient(135deg, #1a73e8 0%, #174ea6 100%);
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      transition: all 0.2s;
    }

    .insert-button:hover {
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      transform: translateY(-1px);
    }

    .insert-button:active {
      transform: translateY(0);
    }

    .insert-button:disabled {
      background: #dadce0;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    /* Quantities Tab Styles */
    .quantity-controls {
      padding: 12px 15px;
      background: #f9f9f9;
      border-bottom: 1px solid #e0e0e0;
    }

    .quantity-scope {
      margin-bottom: 12px;
    }

    .quantity-scope-label {
      font-size: 11px;
      font-weight: bold;
      color: #333;
      margin-bottom: 6px;
      display: block;
    }

    .scope-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
    }

    .scope-btn {
      padding: 8px 12px;
      border: 1px solid #ddd;
      background: white;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }

    .scope-btn:hover {
      border-color: #1a73e8;
      background: #f8f9fa;
    }

    .scope-btn.active {
      border-color: #1a73e8;
      background: #e8f0fe;
      color: #1a73e8;
      font-weight: bold;
    }

    .quantity-summary {
      padding: 12px 15px;
      background: white;
      border-bottom: 1px solid #e0e0e0;
    }

    .summary-stat {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      font-size: 12px;
    }

    .stat-label {
      color: #666;
    }

    .stat-value {
      font-weight: bold;
      color: #1a73e8;
    }

    .quantity-list-container {
      flex: 1;
      overflow-y: auto;
      padding: 10px 15px;
    }

    .quantity-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      margin-bottom: 6px;
    }

    .qty-item-number {
      font-size: 13px;
      font-weight: 500;
      color: #1a73e8;
      cursor: pointer;
      text-decoration: none;
      transition: all 0.2s;
    }

    .qty-item-number:hover {
      text-decoration: underline;
      color: #174ea6;
    }

    .qty-item-name {
      font-size: 11px;
      color: #666;
      margin-top: 2px;
    }

    .qty-color-indicator {
      width: 20px;
      height: 20px;
      border-radius: 3px;
      border: 1px solid #ddd;
      margin-right: 10px;
      flex-shrink: 0;
    }

    .qty-badge {
      background: #ea4335;
      color: white;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
    }

    .loading {
      text-align: center;
      padding: 40px 20px;
      color: #5f6368;
    }

    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #1a73e8;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #5f6368;
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.3;
    }

    .hidden {
      display: none !important;
    }

    .help-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      background: #1a73e8;
      color: white;
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.2s;
      margin-left: 8px;
    }

    .help-icon:hover {
      background: #174ea6;
      transform: scale(1.1);
    }

    .help-icon svg {
      width: 16px;
      height: 16px;
    }

    .tab-header {
      display: flex;
      align-items: center;
      padding: 0 15px 10px 15px;
      font-size: 14px;
      color: #5f6368;
    }

    /* Rename Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal-overlay.show {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      background: linear-gradient(135deg, #1a73e8 0%, #1557b0 100%);
      color: white;
      padding: 20px 24px;
      border-radius: 8px 8px 0 0;
    }

    .modal-header h3 {
      margin: 0;
      font-size: 18px;
      font-weight: 500;
    }

    .modal-body {
      padding: 24px;
    }

    .modal-field {
      margin-bottom: 16px;
    }

    .modal-field label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      color: #333;
      margin-bottom: 6px;
    }

    .modal-field input, .modal-field textarea {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #dadce0;
      border-radius: 4px;
      font-size: 13px;
      font-family: Arial, sans-serif;
    }

    .modal-field input:focus, .modal-field textarea:focus {
      outline: none;
      border-color: #1a73e8;
      box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.1);
    }

    .modal-field textarea {
      min-height: 60px;
      resize: vertical;
    }

    .modal-field-hint {
      font-size: 11px;
      color: #666;
      margin-top: 4px;
    }

    .modal-footer {
      padding: 16px 24px;
      border-top: 1px solid #e0e0e0;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    .modal-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .modal-btn-cancel {
      background: #f1f3f4;
      color: #333;
    }

    .modal-btn-cancel:hover {
      background: #e8eaed;
    }

    .modal-btn-primary {
      background: linear-gradient(135deg, #1a73e8 0%, #174ea6 100%);
      color: white;
    }

    .modal-btn-primary:hover {
      box-shadow: 0 2px 4px rgba(26, 115, 232, 0.3);
    }

    .modal-btn-primary:disabled {
      background: #e0e0e0;
      color: #999;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <div class="header">
      <div style="display: flex; justify-content: space-between; align-items: flex-start;">
        <div style="flex: 1;">
          <h2 style="margin: 0;">Rack Picker</h2>
          <p style="margin: 4px 0 0 0;">Select rack configurations to place in overview</p>
        </div>
        <div style="display: flex; gap: 8px; align-items: flex-start; margin-top: 4px;">
          <button onclick="refreshRackList()" style="padding: 6px 12px; background: #1a73e8; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 500; display: flex; align-items: center; gap: 6px;" title="Reload rack configurations (refreshes sheet names)">
            <svg class="icon icon-sm"><use href="#icon-refresh"></use></svg>
            Refresh
          </button>
          <span class="help-icon" onclick="showContextualHelp()" title="Click for help">
            <svg><use href="#icon-help"></use></svg>
          </span>
        </div>
      </div>
    </div>

    <div class="tab-nav">
      <button class="tab-button active" onclick="switchTab('racks')">
        <svg class="icon icon-md" style="margin-right: 6px;"><use href="#icon-server"></use></svg>
        Racks
      </button>
      <button class="tab-button" onclick="switchTab('arena')">
        <svg class="icon icon-md" style="margin-right: 6px;"><use href="#icon-globe"></use></svg>
        From Arena
      </button>
      <button class="tab-button" onclick="switchTab('quantities')">
        <svg class="icon icon-md" style="margin-right: 6px;"><use href="#icon-chart"></use></svg>
        Quantities
      </button>
      <button class="tab-button" onclick="switchTab('templates')">
        <svg class="icon icon-md" style="margin-right: 6px;"><use href="#icon-template"></use></svg>
        Templates
      </button>
    </div>

    <!-- Racks Tab -->
    <div class="tab-content active" id="racksTab">
      <div class="content">
        <div class="tab-header">
          <svg class="icon icon-md" style="margin-right: 6px;"><use href="#icon-server"></use></svg>
          Existing Rack Configurations
        </div>

        <div class="search-box">
          <input type="text"
                 id="searchBox"
                 placeholder="Search rack configurations..."
                 onkeyup="filterRacks()">
        </div>

        <div id="rackList" class="rack-list">
          <div class="loading">
            <div class="spinner"></div>
            <div>Loading rack configurations...</div>
          </div>
        </div>
      </div>

      <button class="insert-button" id="insertButton" onclick="insertRack()" disabled>
        Place Rack in Selected Cell
      </button>
    </div>

    <!-- From Arena Tab -->
    <div class="tab-content" id="arenaTab">
      <div class="content">
        <div class="tab-header">
          <svg class="icon icon-md" style="margin-right: 6px;"><use href="#icon-globe"></use></svg>
          Browse All Arena Items
        </div>

        <div class="search-box">
          <input type="text"
                 id="arenaSearchBox"
                 placeholder="Search Arena items..."
                 onkeyup="filterArenaItems()">
        </div>

        <div id="arenaItemList" class="rack-list">
          <div class="loading">
            <div class="spinner"></div>
            <div>Loading Arena items...</div>
          </div>
        </div>
      </div>

      <button class="insert-button" id="arenaInsertButton" onclick="insertArenaItem()" disabled>
        Place Item (Auto-Create Rack)
      </button>
    </div>

    <!-- Quantities Tab -->
    <div class="tab-content" id="quantitiesTab">
      <div class="quantity-controls">
        <div class="quantity-scope">
          <span class="quantity-scope-label">Count Racks From:</span>
          <div class="scope-buttons">
            <button class="scope-btn active" data-scope="current" onclick="changeScope('current')">
              Current Sheet
            </button>
            <button class="scope-btn" data-scope="overview" onclick="changeScope('overview')">
              Overview Only
            </button>
            <button class="scope-btn" data-scope="racks" onclick="changeScope('racks')">
              All Racks
            </button>
            <button class="scope-btn" data-scope="all" onclick="changeScope('all')">
              All Sheets
            </button>
          </div>
        </div>
      </div>

      <div class="quantity-summary">
        <div class="summary-stat">
          <span class="stat-label">Unique Racks:</span>
          <span class="stat-value" id="uniqueCount">0</span>
        </div>
        <div class="summary-stat">
          <span class="stat-label">Total Placements:</span>
          <span class="stat-value" id="totalQuantity">0</span>
        </div>
        <div class="summary-stat">
          <span class="stat-label">Scope:</span>
          <span class="stat-value" id="scopeName">Current Sheet</span>
        </div>
      </div>

      <div id="quantitiesLoading" class="loading hidden">
        <div class="spinner"></div>
        <p>Calculating rack usage...</p>
      </div>

      <div class="quantity-list-container" id="quantityListContainer">
        <div class="empty-state">
          <p>No racks found</p>
        </div>
      </div>
    </div>

    <!-- Templates Tab -->
    <div class="tab-content" id="templatesTab">
      <div class="content">
        <div class="tab-header">
          <svg class="icon icon-md" style="margin-right: 6px;"><use href="#icon-template"></use></svg>
          Clone & Templates
        </div>

        <div class="info-box" style="margin-top: 0;">
          <strong>Clone existing racks</strong> to create variants, or <strong>load Arena BOMs</strong> as templates to customize.
        </div>

        <!-- Mode Switcher -->
        <div class="quantity-controls" style="margin-bottom: 12px;">
          <div class="scope-buttons" style="margin: 0 15px;">
            <button class="scope-btn active" id="cloneExistingModeBtn" onclick="switchTemplateMode('clone')">
              <svg class="icon icon-sm" style="margin-right: 4px;"><use href="#icon-clone"></use></svg>
              Clone Existing
            </button>
            <button class="scope-btn" id="arenaTemplateModeBtn" onclick="switchTemplateMode('template')">
              <svg class="icon icon-sm" style="margin-right: 4px;"><use href="#icon-globe"></use></svg>
              Arena Template
            </button>
          </div>
        </div>

        <!-- Clone Existing Mode -->
        <div id="cloneExistingMode" class="template-mode">
          <div class="search-box">
            <input type="text"
                   id="cloneSearchBox"
                   placeholder="Search existing racks to clone..."
                   onkeyup="filterCloneRacks()">
          </div>

          <div id="cloneRackList" class="rack-list">
            <div class="loading">
              <div class="spinner"></div>
              <div>Loading rack configurations...</div>
            </div>
          </div>
        </div>

        <!-- Arena Template Mode -->
        <div id="arenaTemplateMode" class="template-mode" style="display: none;">
          <!-- Search Box with Button -->
          <div class="search-box">
            <div class="search-with-button">
              <input type="text"
                     id="templateSearchBox"
                     placeholder="Search Arena items for templates..."
                     onkeypress="if(event.key==='Enter') performTemplateSearch()">
              <button class="search-button" id="templateSearchButton" onclick="performTemplateSearch()">
                <svg class="icon icon-sm"><use href="#icon-search"></use></svg>
                Search
              </button>
            </div>
          </div>

          <!-- Favorites Toggle -->
          <div class="favorites-toggle">
            <button class="favorites-btn" id="favoritesOnlyBtn" onclick="toggleFavoritesFilter()">
              <svg class="icon icon-sm"><use href="#icon-star"></use></svg>
              Favorites Only
            </button>
            <span style="color: #5f6368; font-size: 11px;" id="favoriteCount">0 favorited</span>
          </div>

          <div id="templateItemList" class="rack-list">
            <div class="loading">
              <div class="spinner"></div>
              <div>Loading Arena items...</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Rename Modal -->
  <div class="modal-overlay" id="renameModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Rename Rack Configuration</h3>
      </div>
      <div class="modal-body">
        <div class="modal-field">
          <label for="renameItemNumber">Item Number</label>
          <input type="text" id="renameItemNumber" placeholder="e.g., Type A">
          <div class="modal-field-hint">Updates column B and the sheet tab name</div>
        </div>
        <div class="modal-field">
          <label for="renameItemName">Item Name</label>
          <input type="text" id="renameItemName" placeholder="e.g., Type A">
          <div class="modal-field-hint">Updates column C</div>
        </div>
        <div class="modal-field">
          <label for="renameDescription">Description (Optional)</label>
          <textarea id="renameDescription" placeholder="e.g., component configuration for Type A"></textarea>
          <div class="modal-field-hint">Updates column D</div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="modal-btn modal-btn-cancel" onclick="closeRenameDialog()">Cancel</button>
        <button class="modal-btn modal-btn-primary" id="renameSubmitBtn" onclick="submitRename()">Rename</button>
      </div>
    </div>
  </div>

  <!-- Clone Modal -->
  <div class="modal-overlay" id="cloneModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="cloneModalTitle">Clone Rack Configuration</h3>
      </div>
      <div class="modal-body">
        <div class="info-box" style="margin-bottom: 12px;">
          <strong>Source:</strong> <span id="cloneSourceInfo">-</span><br>
          <strong>Components:</strong> <span id="cloneComponentCount">-</span>
        </div>
        <div class="modal-field">
          <label for="cloneItemNumber">New Item Number</label>
          <input type="text" id="cloneItemNumber" placeholder="e.g., SERVER-002">
          <div class="modal-field-hint">Unique identifier for the new rack</div>
        </div>
        <div class="modal-field">
          <label for="cloneItemName">New Rack Name</label>
          <input type="text" id="cloneItemName" placeholder="e.g., Server Type B">
          <div class="modal-field-hint">Descriptive name for the rack</div>
        </div>
        <div class="modal-field">
          <label for="cloneDescription">Description (Optional)</label>
          <textarea id="cloneDescription" placeholder="e.g., Cloned from Server Type A"></textarea>
          <div class="modal-field-hint">Optional description</div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="modal-btn modal-btn-cancel" onclick="closeCloneDialog()">Cancel</button>
        <button class="modal-btn modal-btn-primary" id="cloneSubmitBtn" onclick="submitClone()">
          <svg class="icon icon-sm" style="margin-right: 4px;"><use href="#icon-clone"></use></svg>
          Clone Rack
        </button>
      </div>
    </div>
  </div>

  <!-- Template Preview Modal -->
  <div class="modal-overlay" id="templatePreviewModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Load Arena Template</h3>
      </div>
      <div class="modal-body">
        <div class="info-box" style="margin-bottom: 12px; background: #e8f0fe; border-left-color: #1a73e8; color: #174ea6;">
          <strong>ðŸ’¡ Select Components:</strong> Choose which BOM components to include in your template. This lets you create a custom configuration without loading everything first.
        </div>
        <div style="margin-bottom: 12px; padding: 12px; background: #f5f5f5; border-radius: 4px;">
          <div style="margin-bottom: 6px;"><strong>Template Item:</strong> <span id="previewItemNumber">-</span></div>
          <div style="margin-bottom: 6px;"><strong>Name:</strong> <span id="previewItemName">-</span></div>
          <div style="margin-bottom: 6px;">
            <strong>Components:</strong>
            <span id="previewComponentCount">-</span>
            <span id="previewSelectedCount" style="color: #1a73e8; font-weight: 500;"></span>
          </div>
        </div>

        <!-- Component Selection -->
        <div style="margin-bottom: 12px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <label style="font-weight: 500; font-size: 13px;">Select Components to Include:</label>
            <div style="display: flex; gap: 8px;">
              <button type="button" onclick="selectAllComponents()" style="font-size: 11px; padding: 4px 8px; background: #f8f9fa; border: 1px solid #dadce0; border-radius: 3px; cursor: pointer;">Select All</button>
              <button type="button" onclick="deselectAllComponents()" style="font-size: 11px; padding: 4px 8px; background: #f8f9fa; border: 1px solid #dadce0; border-radius: 3px; cursor: pointer;">Deselect All</button>
            </div>
          </div>
          <div id="componentSelectorList" style="max-height: 200px; overflow-y: auto; border: 1px solid #dadce0; border-radius: 4px; background: white;">
            <!-- Component checkboxes will be inserted here -->
          </div>
        </div>
        <div class="modal-field">
          <label for="templateItemNumber">New Item Number</label>
          <input type="text" id="templateItemNumber" placeholder="e.g., MY-CUSTOM-001">
          <div class="modal-field-hint">Item number for your customized rack</div>
        </div>
        <div class="modal-field">
          <label for="templateItemName">New Rack Name</label>
          <input type="text" id="templateItemName" placeholder="e.g., My Custom Server Build">
          <div class="modal-field-hint">Descriptive name for the rack</div>
        </div>
        <div class="modal-field">
          <label for="templateDescription">Description (Optional)</label>
          <textarea id="templateDescription" placeholder="e.g., Template loaded from SERVER-ALL-OPTIONS"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="modal-btn modal-btn-cancel" onclick="closeTemplatePreviewDialog()">Cancel</button>
        <button class="modal-btn modal-btn-primary" id="templateSubmitBtn" onclick="submitTemplateLoad()">
          <svg class="icon icon-sm" style="margin-right: 4px;"><use href="#icon-globe"></use></svg>
          Load Template
        </button>
      </div>
    </div>
  </div>

  <script>
    // DYNAMIC TERMINOLOGY: Loaded from server configuration
    var terminology = {
      entity_singular: 'Configuration',
      entity_plural: 'Configurations',
      entity_singular_lower: 'configuration',
      entity_plural_lower: 'configurations'
    };

    var allRacks = [];
    var selectedRack = null;
    var quantities = {};
    var currentScope = 'current';

    // Arena items tab variables
    var allArenaItems = [];
    var filteredArenaItems = [];
    var selectedArenaItem = null;
    var arenaItemsLoaded = false;

    // Store arena items with GUID for linking
    var arenaItemsLookup = {};

    // Load dynamic terminology from server configuration
    google.script.run
      .withSuccessHandler(function(terms) {
        terminology = terms;
        updateUIWithTerminology();
      })
      .withFailureHandler(function(error) {
        console.log('Using default terminology:', error);
        updateUIWithTerminology();
      })
      .getTerminologyForUI();

    // Load rack configurations when sidebar opens
    google.script.run
      .withSuccessHandler(displayRacks)
      .withFailureHandler(showError)
      .getAllRackConfigurationsForPicker();

    /**
     * Updates all UI text to use dynamic terminology
     */
    function updateUIWithTerminology() {
      var entity = terminology.entity_singular;
      var entities = terminology.entity_plural;
      var entityLower = terminology.entity_singular_lower;
      var entitiesLower = terminology.entity_plural_lower;

      // Update header
      document.querySelector('.header h2').textContent = entity + ' Picker';
      document.querySelector('.header p').textContent = 'Select ' + entitiesLower + ' to place in overview';

      // Update tab buttons
      document.querySelector('.tab-button:nth-child(1)').innerHTML = '<svg class="icon icon-md" style="margin-right: 6px;"><use href="#icon-server"></use></svg>' + entities;

      // Update tab headers
      document.querySelector('.tab-header').innerHTML = '<svg class="icon icon-md" style="margin-right: 6px;"><use href="#icon-server"></use></svg>Existing ' + entity + ' Configurations';

      // Update search placeholder
      document.getElementById('searchBox').placeholder = 'Search ' + entitiesLower + '...';

      // Update button text
      document.getElementById('insertButton').textContent = 'Place ' + entity + ' in Selected Cell';

      // Update from Arena button
      document.getElementById('arenaInsertButton').textContent = 'Place Item (Auto-Create ' + entity + ')';

      // Update quantities tab
      document.querySelector('.quantity-scope-label').textContent = 'Count ' + entities + ' From:';
      var scopeButtons = document.querySelectorAll('.scope-btn');
      scopeButtons[2].innerHTML = 'All ' + entities;
    }

    function switchTab(tabName) {
      // Update tab buttons
      var buttons = document.querySelectorAll('.tab-button');
      buttons.forEach(function(btn) {
        btn.classList.remove('active');
      });
      event.currentTarget.classList.add('active');

      // Update tab content
      var tabs = document.querySelectorAll('.tab-content');
      tabs.forEach(function(tab) {
        tab.classList.remove('active');
      });

      if (tabName === 'racks') {
        document.getElementById('racksTab').classList.add('active');
      } else if (tabName === 'arena') {
        document.getElementById('arenaTab').classList.add('active');
        loadArenaItems(); // Load Arena items when tab is opened
      } else if (tabName === 'quantities') {
        document.getElementById('quantitiesTab').classList.add('active');
        loadQuantities(); // Load quantities when tab is opened
      } else if (tabName === 'templates') {
        document.getElementById('templatesTab').classList.add('active');
        loadTemplatesTab(); // Load templates tab content
      }
    }

    // ============================================================================
    // TEMPLATES TAB FUNCTIONS
    // ============================================================================

    var currentTemplateMode = 'clone'; // 'clone' or 'template'
    var cloneRacks = [];
    var selectedCloneRack = null;
    var templateItems = [];
    var selectedTemplateItem = null;
    var cloneRacksLoaded = false;
    var templateItemsLoaded = false;
    var templateFavorites = [];
    var showFavoritesOnly = false;
    var templatePreviewComponents = [];  // Full component list from preview
    var selectedComponentIndices = [];   // Indices of selected components

    /**
     * Loads the Templates tab content
     */
    function loadTemplatesTab() {
      console.log('ðŸ“‹ Loading Templates tab...');

      // Check if we should open in a specific mode (set by menu action)
      google.script.run
        .withSuccessHandler(function(mode) {
          if (mode === 'clone' || mode === 'template') {
            switchTemplateMode(mode);
          } else {
            // Default to clone mode
            if (!cloneRacksLoaded) {
              loadCloneRacks();
            }
          }
        })
        .withFailureHandler(function(error) {
          console.log('Error getting mode preference:', error);
          if (!cloneRacksLoaded) {
            loadCloneRacks();
          }
        })
        .getProperty('rack_picker_mode');

      // Load favorites from server
      loadTemplateFavorites();
    }

    /**
     * Loads template favorites from server
     */
    function loadTemplateFavorites() {
      google.script.run
        .withSuccessHandler(function(favorites) {
          templateFavorites = favorites || [];
          updateFavoriteCount();
          console.log('Loaded ' + templateFavorites.length + ' template favorites');
        })
        .withFailureHandler(function(error) {
          console.log('Error loading favorites:', error);
          templateFavorites = [];
        })
        .getTemplateFavorites();
    }

    /**
     * Toggles favorite status for a template item
     */
    function toggleTemplateFavorite(itemNumber, event) {
      if (event) event.stopPropagation();

      var index = templateFavorites.indexOf(itemNumber);
      if (index > -1) {
        // Remove from favorites
        templateFavorites.splice(index, 1);
      } else {
        // Add to favorites
        templateFavorites.push(itemNumber);
      }

      // Save to server
      google.script.run
        .withSuccessHandler(function() {
          updateFavoriteCount();
          // Re-render list to update star icons
          if (showFavoritesOnly) {
            displayTemplateItems(templateItems.filter(function(item) {
              return templateFavorites.indexOf(item.number) > -1;
            }));
          } else {
            displayTemplateItems(templateItems);
          }
        })
        .withFailureHandler(function(error) {
          console.log('Error saving favorite:', error);
        })
        .saveTemplateFavorites(templateFavorites);
    }

    /**
     * Updates favorite count display
     */
    function updateFavoriteCount() {
      var countEl = document.getElementById('favoriteCount');
      if (countEl) {
        countEl.textContent = templateFavorites.length + ' favorited';
      }
    }

    /**
     * Toggles showing favorites only
     */
    function toggleFavoritesFilter() {
      showFavoritesOnly = !showFavoritesOnly;

      var btn = document.getElementById('favoritesOnlyBtn');
      if (showFavoritesOnly) {
        btn.classList.add('active');
        // Show only favorited items
        var favorited = templateItems.filter(function(item) {
          return templateFavorites.indexOf(item.number) > -1;
        });
        displayTemplateItems(favorited);
      } else {
        btn.classList.remove('active');
        // Show all items
        displayTemplateItems(templateItems);
      }
    }

    /**
     * Performs template search when search button clicked
     */
    function performTemplateSearch() {
      var searchTerm = document.getElementById('templateSearchBox').value.trim();

      if (!searchTerm) {
        // If empty, show all items (or favorites if filter active)
        if (showFavoritesOnly) {
          var favorited = templateItems.filter(function(item) {
            return templateFavorites.indexOf(item.number) > -1;
          });
          displayTemplateItems(favorited);
        } else {
          displayTemplateItems(templateItems);
        }
        return;
      }

      // Show loading state
      var btn = document.getElementById('templateSearchButton');
      var originalHTML = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<div class="search-spinner"></div> Searching...';

      // Simulate search delay for UX
      setTimeout(function() {
        filterTemplateItems();
        btn.disabled = false;
        btn.innerHTML = originalHTML;
      }, 300);
    }

    /**
     * Switches between Clone Existing and Arena Template modes
     */
    function switchTemplateMode(mode) {
      currentTemplateMode = mode;

      // Update mode buttons
      document.getElementById('cloneExistingModeBtn').classList.toggle('active', mode === 'clone');
      document.getElementById('arenaTemplateModeBtn').classList.toggle('active', mode === 'template');

      // Show/hide mode sections
      document.getElementById('cloneExistingMode').style.display = mode === 'clone' ? 'block' : 'none';
      document.getElementById('arenaTemplateMode').style.display = mode === 'template' ? 'block' : 'none';

      // Load data if needed
      if (mode === 'clone' && !cloneRacksLoaded) {
        loadCloneRacks();
      } else if (mode === 'template' && !templateItemsLoaded) {
        loadTemplateItems();
      }
    }

    /**
     * Loads racks for cloning
     */
    function loadCloneRacks() {
      console.log('ðŸ”„ Loading racks for cloning...');
      cloneRacksLoaded = true;

      google.script.run
        .withSuccessHandler(function(racks) {
          cloneRacks = racks;
          displayCloneRacks(racks);
        })
        .withFailureHandler(function(error) {
          showCloneError('Failed to load racks: ' + error.message);
        })
        .getRacksForCloning();
    }

    /**
     * Displays clone racks in the list
     */
    function displayCloneRacks(racks) {
      var listDiv = document.getElementById('cloneRackList');

      if (racks.length === 0) {
        listDiv.innerHTML = '<div class="empty-state"><p>No racks available to clone</p></div>';
        return;
      }

      var html = '';
      racks.forEach(function(rack) {
        html += '<div class="rack-item" onclick="selectCloneRack(\'' + escapeHtml(rack.itemNumber) + '\')">';
        html += '  <div class="rack-item-header">';
        html += '    <div class="rack-item-content">';
        html += '      <div style="font-weight: 500; margin-bottom: 4px;">' + escapeHtml(rack.itemNumber) + '</div>';
        html += '      <div style="color: #5f6368; font-size: 12px; margin-bottom: 2px;">' + escapeHtml(rack.itemName) + '</div>';
        html += '      <div style="color: #80868b; font-size: 11px;">' + rack.childItemCount + ' components</div>';
        html += '    </div>';
        html += '    <div class="rack-item-actions">';
        html += '      <button class="rack-action-btn" onclick="event.stopPropagation(); openCloneDialog(\'' + escapeHtml(rack.itemNumber) + '\')" title="Clone this rack">';
        html += '        <svg class="icon icon-sm"><use href="#icon-clone"></use></svg>';
        html += '      </button>';
        html += '    </div>';
        html += '  </div>';
        html += '</div>';
      });

      listDiv.innerHTML = html;
    }

    /**
     * Filters clone racks based on search
     */
    function filterCloneRacks() {
      var searchTerm = document.getElementById('cloneSearchBox').value.toLowerCase();

      if (searchTerm === '') {
        displayCloneRacks(cloneRacks);
        return;
      }

      var filtered = cloneRacks.filter(function(rack) {
        return rack.itemNumber.toLowerCase().includes(searchTerm) ||
               rack.itemName.toLowerCase().includes(searchTerm) ||
               (rack.description && rack.description.toLowerCase().includes(searchTerm));
      });

      displayCloneRacks(filtered);
    }

    /**
     * Selects a rack for cloning
     */
    function selectCloneRack(itemNumber) {
      selectedCloneRack = cloneRacks.find(function(r) { return r.itemNumber === itemNumber; });
      console.log('Selected rack for cloning:', selectedCloneRack);
    }

    /**
     * Opens the clone dialog
     * Can be called from either Racks tab or Templates tab
     */
    function openCloneDialog(itemNumber) {
      // Try to find rack in cloneRacks first (Templates tab), then allRacks (Racks tab)
      var rack = cloneRacks.find(function(r) { return r.itemNumber === itemNumber; });
      if (!rack) {
        rack = allRacks.find(function(r) { return r.itemNumber === itemNumber; });
      }
      if (!rack) return;

      selectedCloneRack = rack;

      // Populate modal
      document.getElementById('cloneModalTitle').textContent = 'Clone ' + terminology.entity_singular;
      document.getElementById('cloneSourceInfo').textContent = rack.itemNumber + ' (' + rack.itemName + ')';
      document.getElementById('cloneComponentCount').textContent = rack.childItemCount + ' components';
      document.getElementById('cloneItemNumber').value = '';
      document.getElementById('cloneItemName').value = '';
      document.getElementById('cloneDescription').value = 'Cloned from ' + rack.itemNumber;

      // Show modal
      document.getElementById('cloneModal').classList.add('show');
    }

    /**
     * Closes the clone dialog
     */
    function closeCloneDialog() {
      document.getElementById('cloneModal').classList.remove('show');
      selectedCloneRack = null;
    }

    /**
     * Submits the clone request
     */
    function submitClone() {
      if (!selectedCloneRack) return;

      var newNumber = document.getElementById('cloneItemNumber').value.trim();
      var newName = document.getElementById('cloneItemName').value.trim();
      var newDesc = document.getElementById('cloneDescription').value.trim();

      if (!newNumber || !newName) {
        alert('Please enter both item number and name.');
        return;
      }

      // Disable button and show loading
      var submitBtn = document.getElementById('cloneSubmitBtn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Cloning...';

      google.script.run
        .withSuccessHandler(function(result) {
          submitBtn.disabled = false;
          submitBtn.innerHTML = '<svg class="icon icon-sm" style="margin-right: 4px;"><use href="#icon-clone"></use></svg>Clone Rack';

          if (result.success) {
            closeCloneDialog();
            alert('âœ“ ' + terminology.entity_singular + ' cloned successfully!\n\n' +
                  'New: ' + result.newRackNumber + ' (' + result.newRackName + ')\n' +
                  'Components: ' + result.componentCount);
          } else {
            alert('âœ— Clone failed:\n\n' + result.message);
          }
        })
        .withFailureHandler(function(error) {
          submitBtn.disabled = false;
          submitBtn.innerHTML = '<svg class="icon icon-sm" style="margin-right: 4px;"><use href="#icon-clone"></use></svg>Clone Rack';
          alert('Error: ' + error.message);
        })
        .handleCloneRackRequest({
          sourceRackNumber: selectedCloneRack.itemNumber,
          newRackNumber: newNumber,
          newRackName: newName,
          newDescription: newDesc
        });
    }

    /**
     * Loads Arena items for templates
     */
    function loadTemplateItems() {
      console.log('ðŸŒ Loading Arena items for templates...');
      templateItemsLoaded = true;

      // Reuse Arena items if already loaded
      if (allArenaItems.length > 0) {
        templateItems = allArenaItems;
        displayTemplateItems(templateItems);
        return;
      }

      // Show loading state
      document.getElementById('templateItemList').innerHTML = `
        <div class="loading">
          <div class="spinner"></div>
          <div>Loading Arena items...</div>
        </div>
      `;

      google.script.run
        .withSuccessHandler(function(data) {
          allArenaItems = data.items || [];
          templateItems = allArenaItems;
          displayTemplateItems(templateItems);
        })
        .withFailureHandler(function(error) {
          showTemplateError('Failed to load Arena items: ' + error.message);
        })
        .loadItemPickerData();
    }

    /**
     * Displays template items in the list
     */
    function displayTemplateItems(items) {
      var listDiv = document.getElementById('templateItemList');

      if (items.length === 0) {
        var msg = showFavoritesOnly ? 'No favorited templates found' : 'No Arena items found';
        listDiv.innerHTML = '<div class="empty-state"><p>' + msg + '</p></div>';
        return;
      }

      var html = '';
      items.forEach(function(item) {
        var category = item.category || 'Uncategorized';
        var isFavorited = templateFavorites.indexOf(item.number) > -1;
        var starIcon = isFavorited ? 'icon-star' : 'icon-star-outline';
        var starClass = isFavorited ? 'favorite-star favorited' : 'favorite-star';

        html += '<div class="rack-item" onclick="selectTemplateItem(\'' + escapeHtml(item.number) + '\')">';
        html += '  <div class="rack-item-header">';
        html += '    <div class="rack-item-content">';
        html += '      <div style="font-weight: 500; margin-bottom: 4px;">' + escapeHtml(item.number) + '</div>';
        html += '      <div style="color: #5f6368; font-size: 12px; margin-bottom: 2px;">' + escapeHtml(item.name) + '</div>';
        html += '      <div style="color: #80868b; font-size: 11px;">' + escapeHtml(category) + '</div>';
        html += '    </div>';
        html += '    <div class="rack-item-actions">';
        html += '      <button class="rack-action-btn ' + starClass + '" onclick="toggleTemplateFavorite(\'' + escapeHtml(item.number) + '\', event)" title="' + (isFavorited ? 'Remove from favorites' : 'Add to favorites') + '">';
        html += '        <svg class="icon icon-sm"><use href="#' + starIcon + '"></use></svg>';
        html += '      </button>';
        html += '      <button class="rack-action-btn" onclick="event.stopPropagation(); openTemplatePreviewDialog(\'' + escapeHtml(item.number) + '\')" title="Load as template">';
        html += '        <svg class="icon icon-sm"><use href="#icon-globe"></use></svg>';
        html += '      </button>';
        html += '    </div>';
        html += '  </div>';
        html += '</div>';
      });

      listDiv.innerHTML = html;
    }

    /**
     * Filters template items based on search
     */
    function filterTemplateItems() {
      var searchTerm = document.getElementById('templateSearchBox').value.toLowerCase();

      if (searchTerm === '') {
        displayTemplateItems(templateItems);
        return;
      }

      var filtered = templateItems.filter(function(item) {
        return item.number.toLowerCase().includes(searchTerm) ||
               item.name.toLowerCase().includes(searchTerm) ||
               (item.category && item.category.toLowerCase().includes(searchTerm));
      });

      displayTemplateItems(filtered);
    }

    /**
     * Selects an Arena item for template
     */
    function selectTemplateItem(itemNumber) {
      selectedTemplateItem = templateItems.find(function(i) { return i.number === itemNumber; });
      console.log('Selected Arena item for template:', selectedTemplateItem);
    }

    /**
     * Opens the template preview dialog
     */
    function openTemplatePreviewDialog(itemNumber) {
      var item = templateItems.find(function(i) { return i.number === itemNumber; });
      if (!item) return;

      selectedTemplateItem = item;

      // Show loading in modal
      var submitBtn = document.getElementById('templateSubmitBtn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Loading preview...';

      document.getElementById('templatePreviewModal').classList.add('show');

      // Fetch preview
      google.script.run
        .withSuccessHandler(function(preview) {
          submitBtn.disabled = false;
          submitBtn.innerHTML = '<svg class="icon icon-sm" style="margin-right: 4px;"><use href="#icon-globe"></use></svg>Load Template';

          if (!preview.success) {
            alert('âœ— Cannot load template:\n\n' + preview.message);
            closeTemplatePreviewDialog();
            return;
          }

          // Store full component list
          templatePreviewComponents = preview.allComponents || preview.firstComponents;

          // Populate preview
          document.getElementById('previewItemNumber').textContent = preview.itemNumber;
          document.getElementById('previewItemName').textContent = preview.itemName;
          document.getElementById('previewComponentCount').textContent = preview.componentCount;

          // Build component selector with checkboxes
          buildComponentSelector(templatePreviewComponents);

          // Select all components by default
          selectedComponentIndices = templatePreviewComponents.map(function(_, i) { return i; });
          updateSelectedCount();

          // Prefill form
          document.getElementById('templateItemNumber').value = '';
          document.getElementById('templateItemName').value = '';
          document.getElementById('templateDescription').value = 'Template loaded from ' + preview.itemNumber;
        })
        .withFailureHandler(function(error) {
          submitBtn.disabled = false;
          submitBtn.innerHTML = '<svg class="icon icon-sm" style="margin-right: 4px;"><use href="#icon-globe"></use></svg>Load Template';
          alert('Error fetching preview: ' + error.message);
          closeTemplatePreviewDialog();
        })
        .getArenaTemplateBOMPreview(itemNumber);
    }

    /**
     * Closes the template preview dialog
     */
    function closeTemplatePreviewDialog() {
      document.getElementById('templatePreviewModal').classList.remove('show');
      selectedTemplateItem = null;
      templatePreviewComponents = [];
      selectedComponentIndices = [];
    }

    /**
     * Builds component selector with checkboxes
     */
    function buildComponentSelector(components) {
      var listDiv = document.getElementById('componentSelectorList');

      if (!components || components.length === 0) {
        listDiv.innerHTML = '<div style="padding: 20px; text-align: center; color: #5f6368;">No components found</div>';
        return;
      }

      var html = '';
      components.forEach(function(comp, index) {
        html += '<div class="component-checkbox-item" onclick="toggleComponentSelection(' + index + ')">';
        html += '  <input type="checkbox" id="comp_' + index + '" checked onchange="handleComponentCheckboxChange(' + index + ')">';
        html += '  <label class="component-checkbox-label" for="comp_' + index + '">';
        html += '    <span class="item-number">' + escapeHtml(comp.itemNumber) + '</span>';
        html += '    <span class="item-name">' + escapeHtml(comp.itemName) + '</span>';
        html += '    <span class="item-qty">Qty: ' + comp.quantity + '</span>';
        html += '  </label>';
        html += '</div>';
      });

      listDiv.innerHTML = html;
    }

    /**
     * Toggles component selection when clicking the row
     */
    function toggleComponentSelection(index) {
      var checkbox = document.getElementById('comp_' + index);
      if (checkbox) {
        checkbox.checked = !checkbox.checked;
        handleComponentCheckboxChange(index);
      }
    }

    /**
     * Handles checkbox change
     */
    function handleComponentCheckboxChange(index) {
      var checkbox = document.getElementById('comp_' + index);
      if (!checkbox) return;

      var idxPos = selectedComponentIndices.indexOf(index);

      if (checkbox.checked && idxPos === -1) {
        selectedComponentIndices.push(index);
      } else if (!checkbox.checked && idxPos > -1) {
        selectedComponentIndices.splice(idxPos, 1);
      }

      updateSelectedCount();
    }

    /**
     * Updates selected component count display
     */
    function updateSelectedCount() {
      var countEl = document.getElementById('previewSelectedCount');
      if (countEl && templatePreviewComponents.length > 0) {
        var selectedCount = selectedComponentIndices.length;
        var totalCount = templatePreviewComponents.length;
        countEl.textContent = ' (' + selectedCount + ' of ' + totalCount + ' selected)';
      }
    }

    /**
     * Selects all components
     */
    function selectAllComponents() {
      selectedComponentIndices = templatePreviewComponents.map(function(_, i) { return i; });

      // Update all checkboxes
      templatePreviewComponents.forEach(function(_, index) {
        var checkbox = document.getElementById('comp_' + index);
        if (checkbox) checkbox.checked = true;
      });

      updateSelectedCount();
    }

    /**
     * Deselects all components
     */
    function deselectAllComponents() {
      selectedComponentIndices = [];

      // Update all checkboxes
      templatePreviewComponents.forEach(function(_, index) {
        var checkbox = document.getElementById('comp_' + index);
        if (checkbox) checkbox.checked = false;
      });

      updateSelectedCount();
    }

    /**
     * Submits the template load request
     */
    function submitTemplateLoad() {
      if (!selectedTemplateItem) return;

      var newNumber = document.getElementById('templateItemNumber').value.trim();
      var newName = document.getElementById('templateItemName').value.trim();
      var newDesc = document.getElementById('templateDescription').value.trim();

      if (!newNumber || !newName) {
        alert('Please enter both item number and name.');
        return;
      }

      // Validate at least one component is selected
      if (selectedComponentIndices.length === 0) {
        alert('Please select at least one component to include in the template.');
        return;
      }

      // Get selected components
      var selectedComponents = selectedComponentIndices.map(function(index) {
        return templatePreviewComponents[index];
      });

      // Disable button and show loading
      var submitBtn = document.getElementById('templateSubmitBtn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Loading template...';

      google.script.run
        .withSuccessHandler(function(result) {
          submitBtn.disabled = false;
          submitBtn.innerHTML = '<svg class="icon icon-sm" style="margin-right: 4px;"><use href="#icon-globe"></use></svg>Load Template';

          if (result.success) {
            closeTemplatePreviewDialog();
            var msg = 'âœ“ Template loaded successfully!\n\n' +
                      'New: ' + result.newRackNumber + ' (' + result.newRackName + ')\n' +
                      'Components: ' + result.componentCount;

            // Don't show trim warning if user already selected components
            if (selectedComponentIndices.length === templatePreviewComponents.length) {
              msg += '\n\nâš  Review components before pushing to Arena.';
            } else {
              msg += '\n\nYou selected ' + selectedComponentIndices.length + ' of ' + templatePreviewComponents.length + ' available components.';
            }

            alert(msg);
          } else {
            alert('âœ— Template load failed:\n\n' + result.message);
          }
        })
        .withFailureHandler(function(error) {
          submitBtn.disabled = false;
          submitBtn.innerHTML = '<svg class="icon icon-sm" style="margin-right: 4px;"><use href="#icon-globe"></use></svg>Load Template';
          alert('Error: ' + error.message);
        })
        .handleTemplateLoadRequest({
          arenaItemNumber: selectedTemplateItem.number,
          newRackNumber: newNumber,
          newRackName: newName,
          newDescription: newDesc,
          selectedComponents: selectedComponents
        });
    }

    /**
     * Shows error in clone list
     */
    function showCloneError(message) {
      document.getElementById('cloneRackList').innerHTML =
        '<div class="empty-state"><p style="color: #d32f2f;">' + escapeHtml(message) + '</p></div>';
    }

    /**
     * Shows error in template list
     */
    function showTemplateError(message) {
      document.getElementById('templateItemList').innerHTML =
        '<div class="empty-state"><p style="color: #d32f2f;">' + escapeHtml(message) + '</p></div>';
    }

    /**
     * HTML escape utility
     */
    function escapeHtml(text) {
      if (!text) return '';
      var map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
      };
      return text.toString().replace(/[&<>"']/g, function(m) { return map[m]; });
    }

    // ============================================================================
    // END TEMPLATES TAB FUNCTIONS
    // ============================================================================

    /**
     * Refresh the rack list (reload from server)
     */
    function refreshRackList() {
      console.log('ðŸ”„ Refreshing rack configurations...');

      // Show loading state
      document.getElementById('rackList').innerHTML = `
        <div class="loading">
          <div class="spinner"></div>
          <div>Refreshing rack configurations...</div>
        </div>
      `;

      // Reload rack configurations
      google.script.run
        .withSuccessHandler(function(racks) {
          displayRacks(racks);
          console.log('âœ… Rack configurations refreshed (' + racks.length + ' racks)');
        })
        .withFailureHandler(function(error) {
          console.error('Error refreshing racks:', error);
          showError(error);
        })
        .getAllRackConfigurationsForPicker();
    }

    function displayRacks(racks) {
      allRacks = racks;

      if (racks.length === 0) {
        var entity = terminology.entity_singular_lower;
        document.getElementById('rackList').innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">
              <svg class="icon" style="width: 48px; height: 48px; opacity: 0.3;"><use href="#icon-server"></use></svg>
            </div>
            <div><strong>No ` + entity + ` configurations found</strong></div>
            <div style="margin-top: 8px; font-size: 12px;">
              Create ` + entity + ` configurations using:<br>
              Create Layout â†’ New ` + terminology.entity_singular + ` Configuration
            </div>
          </div>
        `;
        return;
      }

      renderRacks(racks);
    }

    function renderRacks(racks) {
      var html = '';

      racks.forEach(function(rack) {
        var childCount = rack.childItemCount || 0;
        var childText = childCount === 1 ? '1 item' : childCount + ' items';

        // Escape quotes for attributes
        var escapedItemNumber = rack.itemNumber.replace(/'/g, "\\'");
        var escapedItemName = (rack.itemName || 'Unnamed Rack').replace(/'/g, "\\'");
        var escapedDescription = (rack.description || '').replace(/'/g, "\\'");

        html += `
          <div class="rack-item" onclick="selectRack('${escapedItemNumber}')">
            <div class="rack-item-header">
              <div class="rack-item-content">
                <div class="rack-number">${rack.itemNumber}</div>
                <div class="rack-name">${rack.itemName || 'Unnamed Rack'}</div>
                ${rack.description ? '<div class="rack-description">' + rack.description + '</div>' : ''}
                <div class="rack-stats">
                  <span><svg class="icon icon-sm" style="margin-right: 4px;"><use href="#icon-package"></use></svg>${childText}</span>
                  <span><svg class="icon icon-sm" style="margin-right: 4px;"><use href="#icon-document"></use></svg>${rack.sheetName}</span>
                </div>
              </div>
              <div class="rack-item-actions">
                <button class="rack-action-btn" onclick="openCloneDialog('${escapedItemNumber}'); event.stopPropagation();" title="Clone this rack">
                  <svg><use href="#icon-clone"></use></svg>
                </button>
                <button class="rack-action-btn" onclick="showRenameDialog('${escapedItemNumber}', '${escapedItemName}', '${escapedDescription}'); event.stopPropagation();" title="Rename rack configuration">
                  <svg><use href="#icon-pencil"></use></svg>
                </button>
              </div>
            </div>
          </div>
        `;
      });

      document.getElementById('rackList').innerHTML = html;
    }

    function selectRack(itemNumber) {
      selectedRack = allRacks.find(function(r) { return r.itemNumber === itemNumber; });

      // Update UI
      var rackItems = document.querySelectorAll('.rack-item');
      rackItems.forEach(function(item) {
        item.classList.remove('selected');
      });
      event.currentTarget.classList.add('selected');

      // Enable insert button
      document.getElementById('insertButton').disabled = false;
    }

    function insertRack() {
      if (!selectedRack) {
        alert('Please select a ' + terminology.entity_singular_lower + ' first');
        return;
      }

      // Disable button during insertion
      var button = document.getElementById('insertButton');
      var entity = terminology.entity_singular;
      button.disabled = true;
      button.textContent = 'Placing ' + terminology.entity_singular_lower + '...';

      google.script.run
        .withSuccessHandler(function() {
          button.textContent = 'Place ' + entity + ' in Selected Cell';
          button.disabled = false;

          // Show success feedback
          showToast(entity + ' placed successfully!');
        })
        .withFailureHandler(function(error) {
          alert('Error placing ' + terminology.entity_singular_lower + ': ' + error.message);
          button.textContent = 'Place ' + entity + ' in Selected Cell';
          button.disabled = false;
        })
        .insertSelectedRack(selectedRack);
    }

    function filterRacks() {
      var searchText = document.getElementById('searchBox').value.toLowerCase();

      if (!searchText) {
        renderRacks(allRacks);
        return;
      }

      var filtered = allRacks.filter(function(rack) {
        return (rack.itemNumber && rack.itemNumber.toLowerCase().indexOf(searchText) !== -1) ||
               (rack.itemName && rack.itemName.toLowerCase().indexOf(searchText) !== -1) ||
               (rack.description && rack.description.toLowerCase().indexOf(searchText) !== -1);
      });

      renderRacks(filtered);
    }

    function showError(error) {
      var entities = terminology.entity_plural_lower;
      document.getElementById('rackList').innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">âš ï¸</div>
          <div><strong>Error loading ` + entities + `</strong></div>
          <div style="margin-top: 8px; font-size: 12px; color: #d93025;">
            ${error.message}
          </div>
        </div>
      `;
    }

    function showToast(message) {
      var toast = document.createElement('div');
      toast.style.cssText = `
        position: fixed;
        top: 16px;
        left: 50%;
        transform: translateX(-50%);
        background: #188038;
        color: white;
        padding: 12px 24px;
        border-radius: 4px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        z-index: 1000;
        font-size: 14px;
      `;
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(function() {
        toast.remove();
      }, 2000);
    }

    function showContextualHelp() {
      // Determine which tab is active and show appropriate help
      if (document.getElementById('racksTab').classList.contains('active')) {
        showRacksHelp();
      } else if (document.getElementById('arenaTab').classList.contains('active')) {
        showArenaHelp();
      } else if (document.getElementById('quantitiesTab').classList.contains('active')) {
        showQuantitiesHelp();
      }
    }

    function showRacksHelp() {
      alert(
        'ðŸ—„ï¸ RACKS TAB HELP\n\n' +
        'WHAT IT SHOWS:\n' +
        'â€¢ All rack configuration tabs in this spreadsheet\n' +
        'â€¢ Automatically updates when you create new racks\n\n' +
        'HOW TO USE:\n' +
        '1. Select cell(s) in your overview layout\n' +
        '2. Choose a rack from the list\n' +
        '3. Click "Place Rack in Selected Cell"\n\n' +
        'TIPS:\n' +
        'â€¢ Select single cell for 1x1 placement\n' +
        'â€¢ Select multiple cells for merged placement\n' +
        'â€¢ Use "From Arena" tab to create new racks'
      );
    }

    function showArenaHelp() {
      alert(
        'ðŸŒ FROM ARENA TAB HELP\n\n' +
        'WHAT IT DOES:\n' +
        'â€¢ Browse ALL items from your Arena workspace\n' +
        'â€¢ Auto-create rack configuration with BOM\n' +
        'â€¢ Perfect for items without existing rack tabs\n\n' +
        'HOW TO USE:\n' +
        '1. Search for an Arena item\n' +
        '2. Select it from the list\n' +
        '3. Select cell(s) in overview\n' +
        '4. Click "Place Item (Auto-Create Rack)"\n\n' +
        'WHAT HAPPENS:\n' +
        'â€¢ Creates new rack config tab\n' +
        'â€¢ Pulls BOM from Arena\n' +
        'â€¢ Places rack in overview\n' +
        'â€¢ Adds to "Racks" tab list automatically'
      );
    }

    function showQuantitiesHelp() {
      alert(
        'ðŸ“Š QUANTITIES TAB HELP\n\n' +
        'WHAT IT SHOWS:\n' +
        'â€¢ How many times each rack appears\n' +
        'â€¢ Count from different scopes\n\n' +
        'SCOPES:\n' +
        'â€¢ Current Sheet: Count in active sheet only\n' +
        'â€¢ Overview Only: Count in overview layouts\n' +
        'â€¢ All Racks: Count in all rack config tabs\n' +
        'â€¢ All Sheets: Count across entire spreadsheet\n\n' +
        'USE CASES:\n' +
        'â€¢ Track rack usage across data center\n' +
        'â€¢ Find duplicate rack placements\n' +
        'â€¢ Inventory management'
      );
    }

    // Arena Items Tab Functions
    function loadArenaItems() {
      // Only load once
      if (arenaItemsLoaded) {
        return;
      }

      document.getElementById('arenaItemList').innerHTML = `
        <div class="loading">
          <div class="spinner"></div>
          <div>Loading Arena items...</div>
        </div>
      `;

      google.script.run
        .withSuccessHandler(function(data) {
          allArenaItems = data.items || [];
          filteredArenaItems = allArenaItems;
          arenaItemsLoaded = true;

          // Build lookup for quantities tab
          arenaItemsLookup = {};
          allArenaItems.forEach(function(item) {
            var number = item.number || item.Number;
            if (number) {
              arenaItemsLookup[number] = item;
            }
          });

          renderArenaItems(filteredArenaItems);
        })
        .withFailureHandler(function(error) {
          document.getElementById('arenaItemList').innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">âš ï¸</div>
              <div><strong>Error loading Arena items</strong></div>
              <div style="margin-top: 8px; font-size: 12px; color: #d93025;">
                ${error.message}
              </div>
            </div>
          `;
        })
        .loadItemPickerData();
    }

    function renderArenaItems(items) {
      var html = '';

      if (items.length === 0) {
        html = `
          <div class="empty-state">
            <div class="empty-state-icon">ðŸ”</div>
            <div><strong>No items found</strong></div>
            <div style="margin-top: 8px; font-size: 12px;">
              Try adjusting your search
            </div>
          </div>
        `;
      } else {
        items.forEach(function(item) {
          var itemNumber = item.number || item.Number || '';
          var itemName = item.name || item.Name || '';
          var description = item.description || item.Description || '';
          var categoryName = item.categoryName || '';
          var lifecyclePhase = item.lifecyclePhase || '';

          html += `
            <div class="rack-item" onclick="selectArenaItem('${itemNumber}')">
              <div class="rack-number">${itemNumber}</div>
              <div class="rack-name">${itemName}</div>
              ${description ? '<div class="rack-description">' + description + '</div>' : ''}
              <div class="rack-stats">
                ${categoryName ? '<span>ðŸ“ ' + categoryName + '</span>' : ''}
                ${lifecyclePhase ? '<span>ðŸ”„ ' + lifecyclePhase + '</span>' : ''}
              </div>
            </div>
          `;
        });
      }

      document.getElementById('arenaItemList').innerHTML = html;
    }

    function selectArenaItem(itemNumber) {
      selectedArenaItem = allArenaItems.find(function(item) {
        var number = item.number || item.Number || '';
        return number === itemNumber;
      });

      // Update UI
      var items = document.querySelectorAll('#arenaItemList .rack-item');
      items.forEach(function(item) {
        item.classList.remove('selected');
      });
      event.currentTarget.classList.add('selected');

      // Enable insert button
      document.getElementById('arenaInsertButton').disabled = false;
    }

    function filterArenaItems() {
      var searchText = document.getElementById('arenaSearchBox').value.toLowerCase();

      if (!searchText) {
        filteredArenaItems = allArenaItems;
      } else {
        filteredArenaItems = allArenaItems.filter(function(item) {
          var number = (item.number || item.Number || '').toLowerCase();
          var name = (item.name || item.Name || '').toLowerCase();
          var description = (item.description || item.Description || '').toLowerCase();
          var category = (item.categoryName || '').toLowerCase();

          return number.indexOf(searchText) !== -1 ||
                 name.indexOf(searchText) !== -1 ||
                 description.indexOf(searchText) !== -1 ||
                 category.indexOf(searchText) !== -1;
        });
      }

      renderArenaItems(filteredArenaItems);
    }

    function insertArenaItem() {
      if (!selectedArenaItem) {
        alert('Please select an Arena item first');
        return;
      }

      // Disable button during insertion
      var button = document.getElementById('arenaInsertButton');
      var entity = terminology.entity_singular;
      var entityLower = terminology.entity_singular_lower;
      var entitiesLower = terminology.entity_plural_lower;
      button.disabled = true;
      button.textContent = 'Creating ' + entityLower + ' & pulling BOM...';

      google.script.run
        .withSuccessHandler(function() {
          button.textContent = 'Place Item (Auto-Create ' + entity + ')';
          button.disabled = false;

          // Reload rack list and update the UI
          google.script.run
            .withSuccessHandler(function(racks) {
              allRacks = racks;
              // Update the visual display in the Racks tab
              renderRacks(racks);
              console.log('âœ… ' + entity + ' list refreshed - ' + racks.length + ' ' + entitiesLower + ' available');

              // Show success feedback with count
              var itemName = selectedArenaItem.number || selectedArenaItem.name;
              showToast('âœ… ' + entity + ' "' + itemName + '" created!\nðŸ“¦ ' + racks.length + ' ' + entitiesLower + ' available');
            })
            .getAllRackConfigurationsForPicker();
        })
        .withFailureHandler(function(error) {
          alert('Error placing item: ' + error.message);
          button.textContent = 'Place Item (Auto-Create ' + entity + ')';
          button.disabled = false;
        })
        .insertSelectedRack(selectedArenaItem);
    }

    // Quantities Tab Functions
    function changeScope(scope) {
      currentScope = scope;

      // Update button states
      var buttons = document.querySelectorAll('.scope-btn');
      buttons.forEach(function(btn) {
        btn.classList.remove('show');
        if (btn.dataset.scope === scope) {
          btn.classList.add('show');
        }
      });

      // Update scope name
      var scopeNames = {
        'current': 'Current Sheet',
        'overview': 'Overview Only',
        'racks': 'All ' + terminology.entity_singular + ' Configurations',
        'all': 'All Sheets'
      };
      document.getElementById('scopeName').textContent = scopeNames[scope];

      // Reload quantities
      loadQuantities();
    }

    function loadQuantities() {
      document.getElementById('quantitiesLoading').classList.remove('hidden');
      document.getElementById('quantityListContainer').innerHTML = '';

      google.script.run
        .withSuccessHandler(function(data) {
          quantities = data.quantities || {};
          renderQuantities();
          document.getElementById('quantitiesLoading').classList.add('hidden');
        })
        .withFailureHandler(function(error) {
          console.error('Error loading quantities:', error);
          document.getElementById('quantitiesLoading').classList.add('hidden');
          document.getElementById('quantityListContainer').innerHTML =
            '<div class="empty-state"><p>Error loading ' + terminology.entity_singular_lower + ' usage</p></div>';
        })
        .getRackQuantitiesWithScope(currentScope);
    }

    function renderQuantities() {
      var container = document.getElementById('quantityListContainer');
      container.innerHTML = '';

      var rackNumbers = Object.keys(quantities);

      if (rackNumbers.length === 0) {
        container.innerHTML = '<div class="empty-state"><p>No ' + terminology.entity_plural_lower + ' found in selected scope</p></div>';
        document.getElementById('uniqueCount').textContent = '0';
        document.getElementById('totalQuantity').textContent = '0';
        return;
      }

      var totalQty = 0;

      // Sort by quantity (descending)
      rackNumbers.sort(function(a, b) {
        return quantities[b] - quantities[a];
      });

      rackNumbers.forEach(function(number) {
        var qty = quantities[number];
        totalQty += qty;

        var item = document.createElement('div');
        item.className = 'quantity-item';

        // Add color indicator - get color from server using same logic as placement
        var colorIndicator = document.createElement('div');
        colorIndicator.className = 'qty-color-indicator';
        colorIndicator.style.backgroundColor = getAutoRackColor(number);

        var info = document.createElement('div');
        var numberSpan = document.createElement('div');
        numberSpan.className = 'qty-item-number';
        numberSpan.textContent = number;

        // Try to find rack name and GUID
        var matchingRack = allRacks.find(function(r) { return r.itemNumber === number; });

        // Check arena items lookup for GUID if not in rack configs
        var itemGuid = null;
        if (matchingRack && matchingRack.guid) {
          itemGuid = matchingRack.guid;
        } else if (arenaItemsLookup[number]) {
          itemGuid = arenaItemsLookup[number].guid || arenaItemsLookup[number].Guid;
        }

        // Make rack number clickable to open in Arena
        if (itemGuid) {
          numberSpan.style.cursor = 'pointer';
          numberSpan.title = 'Open in Arena';
          numberSpan.onclick = function() {
            openItemInArena(itemGuid);
          };
        }

        if (matchingRack && matchingRack.itemName) {
          var nameSpan = document.createElement('div');
          nameSpan.className = 'qty-item-name';
          nameSpan.textContent = matchingRack.itemName;
          info.appendChild(numberSpan);
          info.appendChild(nameSpan);
        } else {
          info.appendChild(numberSpan);
        }

        var badge = document.createElement('span');
        badge.className = 'qty-badge';
        badge.textContent = qty;

        item.appendChild(colorIndicator);
        item.appendChild(info);
        item.appendChild(badge);
        container.appendChild(item);
      });

      document.getElementById('uniqueCount').textContent = rackNumbers.length;
      document.getElementById('totalQuantity').textContent = totalQty;
    }

    // Helper function to open item in Arena
    function openItemInArena(itemGuid) {
      if (!itemGuid) {
        alert('Item GUID not available');
        return;
      }

      // Get workspace ID from server and construct Arena URL
      google.script.run
        .withSuccessHandler(function(workspaceId) {
          if (workspaceId) {
            // Arena web UI URL format: https://app.arenasolutions.com/<workspaceId>/item/<itemGuid>
            var arenaUrl = 'https://app.arenasolutions.com/' + workspaceId + '/item/' + itemGuid;
            window.open(arenaUrl, '_blank');
          } else {
            alert('Workspace ID not configured');
          }
        })
        .withFailureHandler(function(error) {
          console.error('Error getting workspace ID:', error);
          alert('Could not open item in Arena: ' + error.message);
        })
        .getWorkspaceId();
    }

    // Generate auto color for rack (matches server-side logic)
    function getAutoRackColor(rackNumber) {
      if (!rackNumber) {
        return '#E3F2FD'; // Default light blue
      }

      // Simple hash function for consistent colors
      var hash = 0;
      for (var i = 0; i < rackNumber.length; i++) {
        hash = rackNumber.charCodeAt(i) + ((hash << 5) - hash);
      }

      // Convert to HSL for better color distribution
      var h = Math.abs(hash % 360);           // Hue: 0-360
      var s = 65 + (Math.abs(hash) % 20);     // Saturation: 65-85%
      var l = 80 + (Math.abs(hash >> 8) % 15); // Lightness: 80-95% (pastel)

      return hslToHex(h, s, l);
    }

    // Convert HSL to Hex
    function hslToHex(h, s, l) {
      s /= 100;
      l /= 100;

      var c = (1 - Math.abs(2 * l - 1)) * s;
      var x = c * (1 - Math.abs((h / 60) % 2 - 1));
      var m = l - c/2;
      var r = 0, g = 0, b = 0;

      if (0 <= h && h < 60) {
        r = c; g = x; b = 0;
      } else if (60 <= h && h < 120) {
        r = x; g = c; b = 0;
      } else if (120 <= h && h < 180) {
        r = 0; g = c; b = x;
      } else if (180 <= h && h < 240) {
        r = 0; g = x; b = c;
      } else if (240 <= h && h < 300) {
        r = x; g = 0; b = c;
      } else if (300 <= h && h < 360) {
        r = c; g = 0; b = x;
      }

      var rHex = Math.round((r + m) * 255).toString(16).padStart(2, '0');
      var gHex = Math.round((g + m) * 255).toString(16).padStart(2, '0');
      var bHex = Math.round((b + m) * 255).toString(16).padStart(2, '0');

      return '#' + rHex + gHex + bHex;
    }

    // Rename functionality
    var currentRenameItemNumber = null;

    function showRenameDialog(itemNumber, itemName, description) {
      currentRenameItemNumber = itemNumber;

      // Populate fields
      document.getElementById('renameItemNumber').value = itemNumber;
      document.getElementById('renameItemName').value = itemName;
      document.getElementById('renameDescription').value = description;

      // Show modal
      document.getElementById('renameModal').classList.add('show');
    }

    function closeRenameDialog() {
      document.getElementById('renameModal').classList.remove('show');
      currentRenameItemNumber = null;
    }

    function submitRename() {
      if (!currentRenameItemNumber) {
        alert('No rack selected for rename');
        return;
      }

      var newItemNumber = document.getElementById('renameItemNumber').value.trim();
      var newItemName = document.getElementById('renameItemName').value.trim();
      var newDescription = document.getElementById('renameDescription').value.trim();

      if (!newItemNumber) {
        alert('Item Number cannot be empty');
        return;
      }

      if (!newItemName) {
        alert('Item Name cannot be empty');
        return;
      }

      // Disable button and show loading state
      var submitBtn = document.getElementById('renameSubmitBtn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Renaming...';

      // Call backend to rename
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            closeRenameDialog();
            refreshRackList();  // Refresh the list to show updated name
            alert('âœ… Rack configuration renamed successfully!\n\nSheet tab and metadata cells have been updated.');
          } else {
            alert('âš ï¸ Rename Failed\n\n' + result.message);
            submitBtn.disabled = false;
            submitBtn.textContent = 'Rename';
          }
        })
        .withFailureHandler(function(error) {
          console.error('Error renaming rack:', error);
          alert('âŒ Error renaming rack:\n\n' + error.message);
          submitBtn.disabled = false;
          submitBtn.textContent = 'Rename';
        })
        .renameRackConfiguration(currentRenameItemNumber, newItemNumber, newItemName, newDescription);
    }

    // Close modal when clicking outside
    document.addEventListener('DOMContentLoaded', function() {
      var modal = document.getElementById('renameModal');
      if (modal) {
        modal.addEventListener('click', function(e) {
          if (e.target === this) {
            closeRenameDialog();
          }
        });
      }
    });
  </script>
</body>
</html>
