<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <!-- SVG Icon Definitions -->
  <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <!-- Server/Rack Icon -->
      <symbol id="icon-server" viewBox="0 0 24 24">
        <path fill="currentColor" d="M4,1H20A1,1 0 0,1 21,2V6A1,1 0 0,1 20,7H4A1,1 0 0,1 3,6V2A1,1 0 0,1 4,1M4,9H20A1,1 0 0,1 21,10V14A1,1 0 0,1 20,15H4A1,1 0 0,1 3,14V10A1,1 0 0,1 4,9M4,17H20A1,1 0 0,1 21,18V22A1,1 0 0,1 20,23H4A1,1 0 0,1 3,22V18A1,1 0 0,1 4,17M9,5H10V3H9V5M9,13H10V11H9V13M9,21H10V19H9V21M5,3V5H7V3H5M5,11V13H7V11H5M5,19V21H7V19H5Z"/>
      </symbol>

      <!-- Globe Icon -->
      <symbol id="icon-globe" viewBox="0 0 24 24">
        <path fill="currentColor" d="M17.9,17.39C17.64,16.59 16.89,16 16,16H15V13A1,1 0 0,0 14,12H8V10H10A1,1 0 0,0 11,9V7H13A2,2 0 0,0 15,5V4.59C17.93,5.77 20,8.64 20,12C20,14.08 19.2,15.97 17.9,17.39M11,19.93C7.05,19.44 4,16.08 4,12C4,11.38 4.08,10.78 4.21,10.21L9,15V16A2,2 0 0,0 11,18M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z"/>
      </symbol>

      <!-- Chart/Bar Chart Icon -->
      <symbol id="icon-chart" viewBox="0 0 24 24">
        <path fill="currentColor" d="M22,21H2V3H4V19H6V10H10V19H12V6H16V19H18V14H22V21Z"/>
      </symbol>

      <!-- Help/Question Icon -->
      <symbol id="icon-help" viewBox="0 0 24 24">
        <path fill="currentColor" d="M10,19H13V22H10V19M12,2C17.35,2.22 19.68,7.62 16.5,11.67C15.67,12.67 14.33,13.33 13.67,14.17C13,15 13,16 13,17H10C10,15.33 10,13.92 10.67,12.92C11.33,11.92 12.67,11.33 13.5,10.67C15.92,8.43 15.32,5.26 12,5A3,3 0 0,0 9,8H6A6,6 0 0,1 12,2Z"/>
      </symbol>

      <!-- Package Icon -->
      <symbol id="icon-package" viewBox="0 0 24 24">
        <path fill="currentColor" d="M21,16.5C21,16.88 20.79,17.21 20.47,17.38L12.57,21.82C12.41,21.94 12.21,22 12,22C11.79,22 11.59,21.94 11.43,21.82L3.53,17.38C3.21,17.21 3,16.88 3,16.5V7.5C3,7.12 3.21,6.79 3.53,6.62L11.43,2.18C11.59,2.06 11.79,2 12,2C12.21,2 12.41,2.06 12.57,2.18L20.47,6.62C20.79,6.79 21,7.12 21,7.5V16.5M12,4.15L6.04,7.5L12,10.85L17.96,7.5L12,4.15M5,15.91L11,19.29V12.58L5,9.21V15.91M19,15.91V9.21L13,12.58V19.29L19,15.91Z"/>
      </symbol>

      <!-- Document Icon -->
      <symbol id="icon-document" viewBox="0 0 24 24">
        <path fill="currentColor" d="M19,3H5C3.89,3 3,3.89 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5C21,3.89 20.1,3 19,3M9,7H11V9H9V7M15,17H9V15H15V17M17,13H9V11H17V13M17,9H13V7H17V9Z"/>
      </symbol>

      <!-- Refresh Icon -->
      <symbol id="icon-refresh" viewBox="0 0 24 24">
        <path fill="currentColor" d="M17.65,6.35C16.2,4.9 14.21,4 12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20C15.73,20 18.84,17.45 19.73,14H17.65C16.83,16.33 14.61,18 12,18A6,6 0 0,1 6,12A6,6 0 0,1 12,6C13.66,6 15.14,6.69 16.22,7.78L13,11H20V4L17.65,6.35Z"/>
      </symbol>

      <!-- Pencil/Edit Icon -->
      <symbol id="icon-pencil" viewBox="0 0 24 24">
        <path fill="currentColor" d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.12,5.12L18.87,8.87M3,17.25V21H6.75L17.81,9.93L14.06,6.18L3,17.25Z"/>
      </symbol>
    </defs>
  </svg>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    /* SVG Icon Utilities */
    .icon {
      display: inline-block;
      width: 18px;
      height: 18px;
      vertical-align: middle;
    }

    .icon-sm {
      width: 14px;
      height: 14px;
    }

    .icon-md {
      width: 18px;
      height: 18px;
    }

    .icon-lg {
      width: 24px;
      height: 24px;
    }

    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      height: 100vh;
      overflow: hidden;
    }

    .sidebar {
      display: flex;
      flex-direction: column;
      height: 100vh;
      background: white;
    }

    .header {
      background: linear-gradient(135deg, #1a73e8 0%, #1557b0 100%);
      color: white;
      padding: 12px 15px;
      border-bottom: 1px solid #e0e0e0;
    }

    .header h2 {
      font-size: 16px;
      font-weight: bold;
      margin-bottom: 2px;
    }

    .header p {
      font-size: 11px;
      opacity: 0.9;
    }

    /* Tab Navigation */
    .tab-nav {
      display: flex;
      background: #f9f9f9;
      border-bottom: 2px solid #e0e0e0;
    }

    .tab-button {
      flex: 1;
      padding: 12px 16px;
      border: none;
      background: none;
      font-size: 13px;
      font-weight: 500;
      color: #666;
      cursor: pointer;
      transition: all 0.2s;
      border-bottom: 3px solid transparent;
    }

    .tab-button:hover {
      background: #f1f3f4;
      color: #333;
    }

    .tab-button.active {
      color: #1a73e8;
      background: white;
      border-bottom-color: #1a73e8;
    }

    .tab-content {
      display: none;
      flex: 1;
      flex-direction: column;
      overflow: hidden;
    }

    .tab-content.active {
      display: flex;
    }

    /* Racks Tab Styles */
    .content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .info-box {
      background: #e8f0fe;
      border-left: 3px solid #1a73e8;
      padding: 12px;
      margin: 12px 15px;
      border-radius: 4px;
      font-size: 12px;
      color: #174ea6;
    }

    .search-box {
      margin: 0 15px 12px 15px;
      position: relative;
    }

    .search-box input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #dadce0;
      border-radius: 4px;
      font-size: 12px;
      box-sizing: border-box;
    }

    .search-box input:focus {
      outline: none;
      border-color: #1a73e8;
      box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.1);
    }

    .rack-list {
      flex: 1;
      overflow-y: auto;
      padding: 0 15px 70px 15px; /* Extra padding for button */
    }

    .rack-item {
      padding: 12px;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.2s;
      background: white;
      position: relative;
    }

    .rack-item-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }

    .rack-item-content {
      flex: 1;
    }

    .rack-item-actions {
      display: flex;
      gap: 4px;
      margin-left: 8px;
    }

    .rack-action-btn {
      padding: 4px;
      background: none;
      border: none;
      cursor: pointer;
      color: #5f6368;
      transition: all 0.2s;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .rack-action-btn:hover {
      background: #f1f3f4;
      color: #1a73e8;
    }

    .rack-action-btn svg {
      width: 16px;
      height: 16px;
    }

    .rack-item:hover {
      border-color: #1a73e8;
      box-shadow: 0 2px 8px rgba(26, 115, 232, 0.15);
    }

    .rack-item.selected {
      background-color: #e8f0fe;
      border-color: #1a73e8;
    }

    .rack-number {
      font-weight: bold;
      color: #1a73e8;
      font-size: 14px;
      margin-bottom: 4px;
    }

    .rack-name {
      font-size: 12px;
      color: #333;
      margin-bottom: 2px;
    }

    .rack-description {
      font-size: 11px;
      color: #80868b;
      margin-bottom: 4px;
    }

    .rack-stats {
      font-size: 11px;
      color: #80868b;
      margin-top: 4px;
      display: flex;
      gap: 12px;
    }

    .insert-button {
      position: fixed;
      bottom: 16px;
      left: 16px;
      right: 16px;
      padding: 12px 24px;
      background: linear-gradient(135deg, #1a73e8 0%, #174ea6 100%);
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      transition: all 0.2s;
    }

    .insert-button:hover {
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      transform: translateY(-1px);
    }

    .insert-button:active {
      transform: translateY(0);
    }

    .insert-button:disabled {
      background: #dadce0;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    /* Quantities Tab Styles */
    .quantity-controls {
      padding: 12px 15px;
      background: #f9f9f9;
      border-bottom: 1px solid #e0e0e0;
    }

    .quantity-scope {
      margin-bottom: 12px;
    }

    .quantity-scope-label {
      font-size: 11px;
      font-weight: bold;
      color: #333;
      margin-bottom: 6px;
      display: block;
    }

    .scope-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
    }

    .scope-btn {
      padding: 8px 12px;
      border: 1px solid #ddd;
      background: white;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }

    .scope-btn:hover {
      border-color: #1a73e8;
      background: #f8f9fa;
    }

    .scope-btn.active {
      border-color: #1a73e8;
      background: #e8f0fe;
      color: #1a73e8;
      font-weight: bold;
    }

    .quantity-summary {
      padding: 12px 15px;
      background: white;
      border-bottom: 1px solid #e0e0e0;
    }

    .summary-stat {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      font-size: 12px;
    }

    .stat-label {
      color: #666;
    }

    .stat-value {
      font-weight: bold;
      color: #1a73e8;
    }

    .quantity-list-container {
      flex: 1;
      overflow-y: auto;
      padding: 10px 15px;
    }

    .quantity-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      margin-bottom: 6px;
    }

    .qty-item-number {
      font-size: 13px;
      font-weight: 500;
      color: #1a73e8;
      cursor: pointer;
      text-decoration: none;
      transition: all 0.2s;
    }

    .qty-item-number:hover {
      text-decoration: underline;
      color: #174ea6;
    }

    .qty-item-name {
      font-size: 11px;
      color: #666;
      margin-top: 2px;
    }

    .qty-color-indicator {
      width: 20px;
      height: 20px;
      border-radius: 3px;
      border: 1px solid #ddd;
      margin-right: 10px;
      flex-shrink: 0;
    }

    .qty-badge {
      background: #ea4335;
      color: white;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
    }

    .loading {
      text-align: center;
      padding: 40px 20px;
      color: #5f6368;
    }

    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #1a73e8;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #5f6368;
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.3;
    }

    .hidden {
      display: none !important;
    }

    .help-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      background: #1a73e8;
      color: white;
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.2s;
      margin-left: 8px;
    }

    .help-icon:hover {
      background: #174ea6;
      transform: scale(1.1);
    }

    .help-icon svg {
      width: 16px;
      height: 16px;
    }

    .tab-header {
      display: flex;
      align-items: center;
      padding: 0 15px 10px 15px;
      font-size: 14px;
      color: #5f6368;
    }

    /* Rename Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal-overlay.show {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      background: linear-gradient(135deg, #1a73e8 0%, #1557b0 100%);
      color: white;
      padding: 20px 24px;
      border-radius: 8px 8px 0 0;
    }

    .modal-header h3 {
      margin: 0;
      font-size: 18px;
      font-weight: 500;
    }

    .modal-body {
      padding: 24px;
    }

    .modal-field {
      margin-bottom: 16px;
    }

    .modal-field label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      color: #333;
      margin-bottom: 6px;
    }

    .modal-field input, .modal-field textarea {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #dadce0;
      border-radius: 4px;
      font-size: 13px;
      font-family: Arial, sans-serif;
    }

    .modal-field input:focus, .modal-field textarea:focus {
      outline: none;
      border-color: #1a73e8;
      box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.1);
    }

    .modal-field textarea {
      min-height: 60px;
      resize: vertical;
    }

    .modal-field-hint {
      font-size: 11px;
      color: #666;
      margin-top: 4px;
    }

    .modal-footer {
      padding: 16px 24px;
      border-top: 1px solid #e0e0e0;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    .modal-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .modal-btn-cancel {
      background: #f1f3f4;
      color: #333;
    }

    .modal-btn-cancel:hover {
      background: #e8eaed;
    }

    .modal-btn-primary {
      background: linear-gradient(135deg, #1a73e8 0%, #174ea6 100%);
      color: white;
    }

    .modal-btn-primary:hover {
      box-shadow: 0 2px 4px rgba(26, 115, 232, 0.3);
    }

    .modal-btn-primary:disabled {
      background: #e0e0e0;
      color: #999;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <div class="header">
      <div style="display: flex; justify-content: space-between; align-items: flex-start;">
        <div style="flex: 1;">
          <h2 style="margin: 0;">Rack Picker</h2>
          <p style="margin: 4px 0 0 0;">Select rack configurations to place in overview</p>
        </div>
        <div style="display: flex; gap: 8px; align-items: flex-start; margin-top: 4px;">
          <button onclick="refreshRackList()" style="padding: 6px 12px; background: #1a73e8; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 500; display: flex; align-items: center; gap: 6px;" title="Reload rack configurations (refreshes sheet names)">
            <svg class="icon icon-sm"><use href="#icon-refresh"></use></svg>
            Refresh
          </button>
          <span class="help-icon" onclick="showContextualHelp()" title="Click for help">
            <svg><use href="#icon-help"></use></svg>
          </span>
        </div>
      </div>
    </div>

    <div class="tab-nav">
      <button class="tab-button active" onclick="switchTab('racks')">
        <svg class="icon icon-md" style="margin-right: 6px;"><use href="#icon-server"></use></svg>
        Racks
      </button>
      <button class="tab-button" onclick="switchTab('arena')">
        <svg class="icon icon-md" style="margin-right: 6px;"><use href="#icon-globe"></use></svg>
        From Arena
      </button>
      <button class="tab-button" onclick="switchTab('quantities')">
        <svg class="icon icon-md" style="margin-right: 6px;"><use href="#icon-chart"></use></svg>
        Quantities
      </button>
    </div>

    <!-- Racks Tab -->
    <div class="tab-content active" id="racksTab">
      <div class="content">
        <div class="tab-header">
          <svg class="icon icon-md" style="margin-right: 6px;"><use href="#icon-server"></use></svg>
          Existing Rack Configurations
        </div>

        <div class="search-box">
          <input type="text"
                 id="searchBox"
                 placeholder="Search rack configurations..."
                 onkeyup="filterRacks()">
        </div>

        <div id="rackList" class="rack-list">
          <div class="loading">
            <div class="spinner"></div>
            <div>Loading rack configurations...</div>
          </div>
        </div>
      </div>

      <button class="insert-button" id="insertButton" onclick="insertRack()" disabled>
        Place Rack in Selected Cell
      </button>
    </div>

    <!-- From Arena Tab -->
    <div class="tab-content" id="arenaTab">
      <div class="content">
        <div class="tab-header">
          <svg class="icon icon-md" style="margin-right: 6px;"><use href="#icon-globe"></use></svg>
          Browse All Arena Items
        </div>

        <div class="search-box">
          <input type="text"
                 id="arenaSearchBox"
                 placeholder="Search Arena items..."
                 onkeyup="filterArenaItems()">
        </div>

        <div id="arenaItemList" class="rack-list">
          <div class="loading">
            <div class="spinner"></div>
            <div>Loading Arena items...</div>
          </div>
        </div>
      </div>

      <button class="insert-button" id="arenaInsertButton" onclick="insertArenaItem()" disabled>
        Place Item (Auto-Create Rack)
      </button>
    </div>

    <!-- Quantities Tab -->
    <div class="tab-content" id="quantitiesTab">
      <div class="quantity-controls">
        <div class="quantity-scope">
          <span class="quantity-scope-label">Count Racks From:</span>
          <div class="scope-buttons">
            <button class="scope-btn active" data-scope="current" onclick="changeScope('current')">
              Current Sheet
            </button>
            <button class="scope-btn" data-scope="overview" onclick="changeScope('overview')">
              Overview Only
            </button>
            <button class="scope-btn" data-scope="racks" onclick="changeScope('racks')">
              All Racks
            </button>
            <button class="scope-btn" data-scope="all" onclick="changeScope('all')">
              All Sheets
            </button>
          </div>
        </div>
      </div>

      <div class="quantity-summary">
        <div class="summary-stat">
          <span class="stat-label">Unique Racks:</span>
          <span class="stat-value" id="uniqueCount">0</span>
        </div>
        <div class="summary-stat">
          <span class="stat-label">Total Placements:</span>
          <span class="stat-value" id="totalQuantity">0</span>
        </div>
        <div class="summary-stat">
          <span class="stat-label">Scope:</span>
          <span class="stat-value" id="scopeName">Current Sheet</span>
        </div>
      </div>

      <div id="quantitiesLoading" class="loading hidden">
        <div class="spinner"></div>
        <p>Calculating rack usage...</p>
      </div>

      <div class="quantity-list-container" id="quantityListContainer">
        <div class="empty-state">
          <p>No racks found</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Rename Modal -->
  <div class="modal-overlay" id="renameModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Rename Rack Configuration</h3>
      </div>
      <div class="modal-body">
        <div class="modal-field">
          <label for="renameItemNumber">Item Number</label>
          <input type="text" id="renameItemNumber" placeholder="e.g., Type A">
          <div class="modal-field-hint">Updates column B and the sheet tab name</div>
        </div>
        <div class="modal-field">
          <label for="renameItemName">Item Name</label>
          <input type="text" id="renameItemName" placeholder="e.g., Type A">
          <div class="modal-field-hint">Updates column C</div>
        </div>
        <div class="modal-field">
          <label for="renameDescription">Description (Optional)</label>
          <textarea id="renameDescription" placeholder="e.g., component configuration for Type A"></textarea>
          <div class="modal-field-hint">Updates column D</div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="modal-btn modal-btn-cancel" onclick="closeRenameDialog()">Cancel</button>
        <button class="modal-btn modal-btn-primary" id="renameSubmitBtn" onclick="submitRename()">Rename</button>
      </div>
    </div>
  </div>

  <script>
    // DYNAMIC TERMINOLOGY: Loaded from server configuration
    var terminology = {
      entity_singular: 'Configuration',
      entity_plural: 'Configurations',
      entity_singular_lower: 'configuration',
      entity_plural_lower: 'configurations'
    };

    var allRacks = [];
    var selectedRack = null;
    var quantities = {};
    var currentScope = 'current';

    // Arena items tab variables
    var allArenaItems = [];
    var filteredArenaItems = [];
    var selectedArenaItem = null;
    var arenaItemsLoaded = false;

    // Store arena items with GUID for linking
    var arenaItemsLookup = {};

    // Load dynamic terminology from server configuration
    google.script.run
      .withSuccessHandler(function(terms) {
        terminology = terms;
        updateUIWithTerminology();
      })
      .withFailureHandler(function(error) {
        console.log('Using default terminology:', error);
        updateUIWithTerminology();
      })
      .getTerminologyForUI();

    // Load rack configurations when sidebar opens
    google.script.run
      .withSuccessHandler(displayRacks)
      .withFailureHandler(showError)
      .getAllRackConfigurationsForPicker();

    /**
     * Updates all UI text to use dynamic terminology
     */
    function updateUIWithTerminology() {
      var entity = terminology.entity_singular;
      var entities = terminology.entity_plural;
      var entityLower = terminology.entity_singular_lower;
      var entitiesLower = terminology.entity_plural_lower;

      // Update header
      document.querySelector('.header h2').textContent = entity + ' Picker';
      document.querySelector('.header p').textContent = 'Select ' + entitiesLower + ' to place in overview';

      // Update tab buttons
      document.querySelector('.tab-button:nth-child(1)').innerHTML = '<svg class="icon icon-md" style="margin-right: 6px;"><use href="#icon-server"></use></svg>' + entities;

      // Update tab headers
      document.querySelector('.tab-header').innerHTML = '<svg class="icon icon-md" style="margin-right: 6px;"><use href="#icon-server"></use></svg>Existing ' + entity + ' Configurations';

      // Update search placeholder
      document.getElementById('searchBox').placeholder = 'Search ' + entitiesLower + '...';

      // Update button text
      document.getElementById('insertButton').textContent = 'Place ' + entity + ' in Selected Cell';

      // Update from Arena button
      document.getElementById('arenaInsertButton').textContent = 'Place Item (Auto-Create ' + entity + ')';

      // Update quantities tab
      document.querySelector('.quantity-scope-label').textContent = 'Count ' + entities + ' From:';
      var scopeButtons = document.querySelectorAll('.scope-btn');
      scopeButtons[2].innerHTML = 'All ' + entities;
    }

    function switchTab(tabName) {
      // Update tab buttons
      var buttons = document.querySelectorAll('.tab-button');
      buttons.forEach(function(btn) {
        btn.classList.remove('active');
      });
      event.currentTarget.classList.add('active');

      // Update tab content
      var tabs = document.querySelectorAll('.tab-content');
      tabs.forEach(function(tab) {
        tab.classList.remove('active');
      });

      if (tabName === 'racks') {
        document.getElementById('racksTab').classList.add('active');
      } else if (tabName === 'arena') {
        document.getElementById('arenaTab').classList.add('active');
        loadArenaItems(); // Load Arena items when tab is opened
      } else if (tabName === 'quantities') {
        document.getElementById('quantitiesTab').classList.add('active');
        loadQuantities(); // Load quantities when tab is opened
      }
    }

    /**
     * Refresh the rack list (reload from server)
     */
    function refreshRackList() {
      console.log('üîÑ Refreshing rack configurations...');

      // Show loading state
      document.getElementById('rackList').innerHTML = `
        <div class="loading">
          <div class="spinner"></div>
          <div>Refreshing rack configurations...</div>
        </div>
      `;

      // Reload rack configurations
      google.script.run
        .withSuccessHandler(function(racks) {
          displayRacks(racks);
          console.log('‚úÖ Rack configurations refreshed (' + racks.length + ' racks)');
        })
        .withFailureHandler(function(error) {
          console.error('Error refreshing racks:', error);
          showError(error);
        })
        .getAllRackConfigurationsForPicker();
    }

    function displayRacks(racks) {
      allRacks = racks;

      if (racks.length === 0) {
        var entity = terminology.entity_singular_lower;
        document.getElementById('rackList').innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">
              <svg class="icon" style="width: 48px; height: 48px; opacity: 0.3;"><use href="#icon-server"></use></svg>
            </div>
            <div><strong>No ` + entity + ` configurations found</strong></div>
            <div style="margin-top: 8px; font-size: 12px;">
              Create ` + entity + ` configurations using:<br>
              Create Layout ‚Üí New ` + terminology.entity_singular + ` Configuration
            </div>
          </div>
        `;
        return;
      }

      renderRacks(racks);
    }

    function renderRacks(racks) {
      var html = '';

      racks.forEach(function(rack) {
        var childCount = rack.childItemCount || 0;
        var childText = childCount === 1 ? '1 item' : childCount + ' items';

        // Escape quotes for attributes
        var escapedItemNumber = rack.itemNumber.replace(/'/g, "\\'");
        var escapedItemName = (rack.itemName || 'Unnamed Rack').replace(/'/g, "\\'");
        var escapedDescription = (rack.description || '').replace(/'/g, "\\'");

        html += `
          <div class="rack-item" onclick="selectRack('${escapedItemNumber}')">
            <div class="rack-item-header">
              <div class="rack-item-content">
                <div class="rack-number">${rack.itemNumber}</div>
                <div class="rack-name">${rack.itemName || 'Unnamed Rack'}</div>
                ${rack.description ? '<div class="rack-description">' + rack.description + '</div>' : ''}
                <div class="rack-stats">
                  <span><svg class="icon icon-sm" style="margin-right: 4px;"><use href="#icon-package"></use></svg>${childText}</span>
                  <span><svg class="icon icon-sm" style="margin-right: 4px;"><use href="#icon-document"></use></svg>${rack.sheetName}</span>
                </div>
              </div>
              <div class="rack-item-actions">
                <button class="rack-action-btn" onclick="showRenameDialog('${escapedItemNumber}', '${escapedItemName}', '${escapedDescription}'); event.stopPropagation();" title="Rename rack configuration">
                  <svg><use href="#icon-pencil"></use></svg>
                </button>
              </div>
            </div>
          </div>
        `;
      });

      document.getElementById('rackList').innerHTML = html;
    }

    function selectRack(itemNumber) {
      selectedRack = allRacks.find(function(r) { return r.itemNumber === itemNumber; });

      // Update UI
      var rackItems = document.querySelectorAll('.rack-item');
      rackItems.forEach(function(item) {
        item.classList.remove('selected');
      });
      event.currentTarget.classList.add('selected');

      // Enable insert button
      document.getElementById('insertButton').disabled = false;
    }

    function insertRack() {
      if (!selectedRack) {
        alert('Please select a ' + terminology.entity_singular_lower + ' first');
        return;
      }

      // Disable button during insertion
      var button = document.getElementById('insertButton');
      var entity = terminology.entity_singular;
      button.disabled = true;
      button.textContent = 'Placing ' + terminology.entity_singular_lower + '...';

      google.script.run
        .withSuccessHandler(function() {
          button.textContent = 'Place ' + entity + ' in Selected Cell';
          button.disabled = false;

          // Show success feedback
          showToast(entity + ' placed successfully!');
        })
        .withFailureHandler(function(error) {
          alert('Error placing ' + terminology.entity_singular_lower + ': ' + error.message);
          button.textContent = 'Place ' + entity + ' in Selected Cell';
          button.disabled = false;
        })
        .insertSelectedRack(selectedRack);
    }

    function filterRacks() {
      var searchText = document.getElementById('searchBox').value.toLowerCase();

      if (!searchText) {
        renderRacks(allRacks);
        return;
      }

      var filtered = allRacks.filter(function(rack) {
        return (rack.itemNumber && rack.itemNumber.toLowerCase().indexOf(searchText) !== -1) ||
               (rack.itemName && rack.itemName.toLowerCase().indexOf(searchText) !== -1) ||
               (rack.description && rack.description.toLowerCase().indexOf(searchText) !== -1);
      });

      renderRacks(filtered);
    }

    function showError(error) {
      var entities = terminology.entity_plural_lower;
      document.getElementById('rackList').innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">‚ö†Ô∏è</div>
          <div><strong>Error loading ` + entities + `</strong></div>
          <div style="margin-top: 8px; font-size: 12px; color: #d93025;">
            ${error.message}
          </div>
        </div>
      `;
    }

    function showToast(message) {
      var toast = document.createElement('div');
      toast.style.cssText = `
        position: fixed;
        top: 16px;
        left: 50%;
        transform: translateX(-50%);
        background: #188038;
        color: white;
        padding: 12px 24px;
        border-radius: 4px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        z-index: 1000;
        font-size: 14px;
      `;
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(function() {
        toast.remove();
      }, 2000);
    }

    function showContextualHelp() {
      // Determine which tab is active and show appropriate help
      if (document.getElementById('racksTab').classList.contains('active')) {
        showRacksHelp();
      } else if (document.getElementById('arenaTab').classList.contains('active')) {
        showArenaHelp();
      } else if (document.getElementById('quantitiesTab').classList.contains('active')) {
        showQuantitiesHelp();
      }
    }

    function showRacksHelp() {
      alert(
        'üóÑÔ∏è RACKS TAB HELP\n\n' +
        'WHAT IT SHOWS:\n' +
        '‚Ä¢ All rack configuration tabs in this spreadsheet\n' +
        '‚Ä¢ Automatically updates when you create new racks\n\n' +
        'HOW TO USE:\n' +
        '1. Select cell(s) in your overview layout\n' +
        '2. Choose a rack from the list\n' +
        '3. Click "Place Rack in Selected Cell"\n\n' +
        'TIPS:\n' +
        '‚Ä¢ Select single cell for 1x1 placement\n' +
        '‚Ä¢ Select multiple cells for merged placement\n' +
        '‚Ä¢ Use "From Arena" tab to create new racks'
      );
    }

    function showArenaHelp() {
      alert(
        'üåê FROM ARENA TAB HELP\n\n' +
        'WHAT IT DOES:\n' +
        '‚Ä¢ Browse ALL items from your Arena workspace\n' +
        '‚Ä¢ Auto-create rack configuration with BOM\n' +
        '‚Ä¢ Perfect for items without existing rack tabs\n\n' +
        'HOW TO USE:\n' +
        '1. Search for an Arena item\n' +
        '2. Select it from the list\n' +
        '3. Select cell(s) in overview\n' +
        '4. Click "Place Item (Auto-Create Rack)"\n\n' +
        'WHAT HAPPENS:\n' +
        '‚Ä¢ Creates new rack config tab\n' +
        '‚Ä¢ Pulls BOM from Arena\n' +
        '‚Ä¢ Places rack in overview\n' +
        '‚Ä¢ Adds to "Racks" tab list automatically'
      );
    }

    function showQuantitiesHelp() {
      alert(
        'üìä QUANTITIES TAB HELP\n\n' +
        'WHAT IT SHOWS:\n' +
        '‚Ä¢ How many times each rack appears\n' +
        '‚Ä¢ Count from different scopes\n\n' +
        'SCOPES:\n' +
        '‚Ä¢ Current Sheet: Count in active sheet only\n' +
        '‚Ä¢ Overview Only: Count in overview layouts\n' +
        '‚Ä¢ All Racks: Count in all rack config tabs\n' +
        '‚Ä¢ All Sheets: Count across entire spreadsheet\n\n' +
        'USE CASES:\n' +
        '‚Ä¢ Track rack usage across data center\n' +
        '‚Ä¢ Find duplicate rack placements\n' +
        '‚Ä¢ Inventory management'
      );
    }

    // Arena Items Tab Functions
    function loadArenaItems() {
      // Only load once
      if (arenaItemsLoaded) {
        return;
      }

      document.getElementById('arenaItemList').innerHTML = `
        <div class="loading">
          <div class="spinner"></div>
          <div>Loading Arena items...</div>
        </div>
      `;

      google.script.run
        .withSuccessHandler(function(data) {
          allArenaItems = data.items || [];
          filteredArenaItems = allArenaItems;
          arenaItemsLoaded = true;

          // Build lookup for quantities tab
          arenaItemsLookup = {};
          allArenaItems.forEach(function(item) {
            var number = item.number || item.Number;
            if (number) {
              arenaItemsLookup[number] = item;
            }
          });

          renderArenaItems(filteredArenaItems);
        })
        .withFailureHandler(function(error) {
          document.getElementById('arenaItemList').innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">‚ö†Ô∏è</div>
              <div><strong>Error loading Arena items</strong></div>
              <div style="margin-top: 8px; font-size: 12px; color: #d93025;">
                ${error.message}
              </div>
            </div>
          `;
        })
        .loadItemPickerData();
    }

    function renderArenaItems(items) {
      var html = '';

      if (items.length === 0) {
        html = `
          <div class="empty-state">
            <div class="empty-state-icon">üîç</div>
            <div><strong>No items found</strong></div>
            <div style="margin-top: 8px; font-size: 12px;">
              Try adjusting your search
            </div>
          </div>
        `;
      } else {
        items.forEach(function(item) {
          var itemNumber = item.number || item.Number || '';
          var itemName = item.name || item.Name || '';
          var description = item.description || item.Description || '';
          var categoryName = item.categoryName || '';
          var lifecyclePhase = item.lifecyclePhase || '';

          html += `
            <div class="rack-item" onclick="selectArenaItem('${itemNumber}')">
              <div class="rack-number">${itemNumber}</div>
              <div class="rack-name">${itemName}</div>
              ${description ? '<div class="rack-description">' + description + '</div>' : ''}
              <div class="rack-stats">
                ${categoryName ? '<span>üìÅ ' + categoryName + '</span>' : ''}
                ${lifecyclePhase ? '<span>üîÑ ' + lifecyclePhase + '</span>' : ''}
              </div>
            </div>
          `;
        });
      }

      document.getElementById('arenaItemList').innerHTML = html;
    }

    function selectArenaItem(itemNumber) {
      selectedArenaItem = allArenaItems.find(function(item) {
        var number = item.number || item.Number || '';
        return number === itemNumber;
      });

      // Update UI
      var items = document.querySelectorAll('#arenaItemList .rack-item');
      items.forEach(function(item) {
        item.classList.remove('selected');
      });
      event.currentTarget.classList.add('selected');

      // Enable insert button
      document.getElementById('arenaInsertButton').disabled = false;
    }

    function filterArenaItems() {
      var searchText = document.getElementById('arenaSearchBox').value.toLowerCase();

      if (!searchText) {
        filteredArenaItems = allArenaItems;
      } else {
        filteredArenaItems = allArenaItems.filter(function(item) {
          var number = (item.number || item.Number || '').toLowerCase();
          var name = (item.name || item.Name || '').toLowerCase();
          var description = (item.description || item.Description || '').toLowerCase();
          var category = (item.categoryName || '').toLowerCase();

          return number.indexOf(searchText) !== -1 ||
                 name.indexOf(searchText) !== -1 ||
                 description.indexOf(searchText) !== -1 ||
                 category.indexOf(searchText) !== -1;
        });
      }

      renderArenaItems(filteredArenaItems);
    }

    function insertArenaItem() {
      if (!selectedArenaItem) {
        alert('Please select an Arena item first');
        return;
      }

      // Disable button during insertion
      var button = document.getElementById('arenaInsertButton');
      var entity = terminology.entity_singular;
      var entityLower = terminology.entity_singular_lower;
      var entitiesLower = terminology.entity_plural_lower;
      button.disabled = true;
      button.textContent = 'Creating ' + entityLower + ' & pulling BOM...';

      google.script.run
        .withSuccessHandler(function() {
          button.textContent = 'Place Item (Auto-Create ' + entity + ')';
          button.disabled = false;

          // Reload rack list and update the UI
          google.script.run
            .withSuccessHandler(function(racks) {
              allRacks = racks;
              // Update the visual display in the Racks tab
              renderRacks(racks);
              console.log('‚úÖ ' + entity + ' list refreshed - ' + racks.length + ' ' + entitiesLower + ' available');

              // Show success feedback with count
              var itemName = selectedArenaItem.number || selectedArenaItem.name;
              showToast('‚úÖ ' + entity + ' "' + itemName + '" created!\nüì¶ ' + racks.length + ' ' + entitiesLower + ' available');
            })
            .getAllRackConfigurationsForPicker();
        })
        .withFailureHandler(function(error) {
          alert('Error placing item: ' + error.message);
          button.textContent = 'Place Item (Auto-Create ' + entity + ')';
          button.disabled = false;
        })
        .insertSelectedRack(selectedArenaItem);
    }

    // Quantities Tab Functions
    function changeScope(scope) {
      currentScope = scope;

      // Update button states
      var buttons = document.querySelectorAll('.scope-btn');
      buttons.forEach(function(btn) {
        btn.classList.remove('active');
        if (btn.dataset.scope === scope) {
          btn.classList.add('active');
        }
      });

      // Update scope name
      var scopeNames = {
        'current': 'Current Sheet',
        'overview': 'Overview Only',
        'racks': 'All ' + terminology.entity_singular + ' Configurations',
        'all': 'All Sheets'
      };
      document.getElementById('scopeName').textContent = scopeNames[scope];

      // Reload quantities
      loadQuantities();
    }

    function loadQuantities() {
      document.getElementById('quantitiesLoading').classList.remove('hidden');
      document.getElementById('quantityListContainer').innerHTML = '';

      google.script.run
        .withSuccessHandler(function(data) {
          quantities = data.quantities || {};
          renderQuantities();
          document.getElementById('quantitiesLoading').classList.add('hidden');
        })
        .withFailureHandler(function(error) {
          console.error('Error loading quantities:', error);
          document.getElementById('quantitiesLoading').classList.add('hidden');
          document.getElementById('quantityListContainer').innerHTML =
            '<div class="empty-state"><p>Error loading ' + terminology.entity_singular_lower + ' usage</p></div>';
        })
        .getRackQuantitiesWithScope(currentScope);
    }

    function renderQuantities() {
      var container = document.getElementById('quantityListContainer');
      container.innerHTML = '';

      var rackNumbers = Object.keys(quantities);

      if (rackNumbers.length === 0) {
        container.innerHTML = '<div class="empty-state"><p>No ' + terminology.entity_plural_lower + ' found in selected scope</p></div>';
        document.getElementById('uniqueCount').textContent = '0';
        document.getElementById('totalQuantity').textContent = '0';
        return;
      }

      var totalQty = 0;

      // Sort by quantity (descending)
      rackNumbers.sort(function(a, b) {
        return quantities[b] - quantities[a];
      });

      rackNumbers.forEach(function(number) {
        var qty = quantities[number];
        totalQty += qty;

        var item = document.createElement('div');
        item.className = 'quantity-item';

        // Add color indicator - get color from server using same logic as placement
        var colorIndicator = document.createElement('div');
        colorIndicator.className = 'qty-color-indicator';
        colorIndicator.style.backgroundColor = getAutoRackColor(number);

        var info = document.createElement('div');
        var numberSpan = document.createElement('div');
        numberSpan.className = 'qty-item-number';
        numberSpan.textContent = number;

        // Try to find rack name and GUID
        var matchingRack = allRacks.find(function(r) { return r.itemNumber === number; });

        // Check arena items lookup for GUID if not in rack configs
        var itemGuid = null;
        if (matchingRack && matchingRack.guid) {
          itemGuid = matchingRack.guid;
        } else if (arenaItemsLookup[number]) {
          itemGuid = arenaItemsLookup[number].guid || arenaItemsLookup[number].Guid;
        }

        // Make rack number clickable to open in Arena
        if (itemGuid) {
          numberSpan.style.cursor = 'pointer';
          numberSpan.title = 'Open in Arena';
          numberSpan.onclick = function() {
            openItemInArena(itemGuid);
          };
        }

        if (matchingRack && matchingRack.itemName) {
          var nameSpan = document.createElement('div');
          nameSpan.className = 'qty-item-name';
          nameSpan.textContent = matchingRack.itemName;
          info.appendChild(numberSpan);
          info.appendChild(nameSpan);
        } else {
          info.appendChild(numberSpan);
        }

        var badge = document.createElement('span');
        badge.className = 'qty-badge';
        badge.textContent = qty;

        item.appendChild(colorIndicator);
        item.appendChild(info);
        item.appendChild(badge);
        container.appendChild(item);
      });

      document.getElementById('uniqueCount').textContent = rackNumbers.length;
      document.getElementById('totalQuantity').textContent = totalQty;
    }

    // Helper function to open item in Arena
    function openItemInArena(itemGuid) {
      if (!itemGuid) {
        alert('Item GUID not available');
        return;
      }

      // Get workspace ID from server and construct Arena URL
      google.script.run
        .withSuccessHandler(function(workspaceId) {
          if (workspaceId) {
            // Arena web UI URL format: https://app.arenasolutions.com/<workspaceId>/item/<itemGuid>
            var arenaUrl = 'https://app.arenasolutions.com/' + workspaceId + '/item/' + itemGuid;
            window.open(arenaUrl, '_blank');
          } else {
            alert('Workspace ID not configured');
          }
        })
        .withFailureHandler(function(error) {
          console.error('Error getting workspace ID:', error);
          alert('Could not open item in Arena: ' + error.message);
        })
        .getWorkspaceId();
    }

    // Generate auto color for rack (matches server-side logic)
    function getAutoRackColor(rackNumber) {
      if (!rackNumber) {
        return '#E3F2FD'; // Default light blue
      }

      // Simple hash function for consistent colors
      var hash = 0;
      for (var i = 0; i < rackNumber.length; i++) {
        hash = rackNumber.charCodeAt(i) + ((hash << 5) - hash);
      }

      // Convert to HSL for better color distribution
      var h = Math.abs(hash % 360);           // Hue: 0-360
      var s = 65 + (Math.abs(hash) % 20);     // Saturation: 65-85%
      var l = 80 + (Math.abs(hash >> 8) % 15); // Lightness: 80-95% (pastel)

      return hslToHex(h, s, l);
    }

    // Convert HSL to Hex
    function hslToHex(h, s, l) {
      s /= 100;
      l /= 100;

      var c = (1 - Math.abs(2 * l - 1)) * s;
      var x = c * (1 - Math.abs((h / 60) % 2 - 1));
      var m = l - c/2;
      var r = 0, g = 0, b = 0;

      if (0 <= h && h < 60) {
        r = c; g = x; b = 0;
      } else if (60 <= h && h < 120) {
        r = x; g = c; b = 0;
      } else if (120 <= h && h < 180) {
        r = 0; g = c; b = x;
      } else if (180 <= h && h < 240) {
        r = 0; g = x; b = c;
      } else if (240 <= h && h < 300) {
        r = x; g = 0; b = c;
      } else if (300 <= h && h < 360) {
        r = c; g = 0; b = x;
      }

      var rHex = Math.round((r + m) * 255).toString(16).padStart(2, '0');
      var gHex = Math.round((g + m) * 255).toString(16).padStart(2, '0');
      var bHex = Math.round((b + m) * 255).toString(16).padStart(2, '0');

      return '#' + rHex + gHex + bHex;
    }

    // Rename functionality
    var currentRenameItemNumber = null;

    function showRenameDialog(itemNumber, itemName, description) {
      currentRenameItemNumber = itemNumber;

      // Populate fields
      document.getElementById('renameItemNumber').value = itemNumber;
      document.getElementById('renameItemName').value = itemName;
      document.getElementById('renameDescription').value = description;

      // Show modal
      document.getElementById('renameModal').classList.add('show');
    }

    function closeRenameDialog() {
      document.getElementById('renameModal').classList.remove('show');
      currentRenameItemNumber = null;
    }

    function submitRename() {
      if (!currentRenameItemNumber) {
        alert('No rack selected for rename');
        return;
      }

      var newItemNumber = document.getElementById('renameItemNumber').value.trim();
      var newItemName = document.getElementById('renameItemName').value.trim();
      var newDescription = document.getElementById('renameDescription').value.trim();

      if (!newItemNumber) {
        alert('Item Number cannot be empty');
        return;
      }

      if (!newItemName) {
        alert('Item Name cannot be empty');
        return;
      }

      // Disable button and show loading state
      var submitBtn = document.getElementById('renameSubmitBtn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Renaming...';

      // Call backend to rename
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            closeRenameDialog();
            refreshRackList();  // Refresh the list to show updated name
            alert('‚úÖ Rack configuration renamed successfully!\n\nSheet tab and metadata cells have been updated.');
          } else {
            alert('‚ö†Ô∏è Rename Failed\n\n' + result.message);
            submitBtn.disabled = false;
            submitBtn.textContent = 'Rename';
          }
        })
        .withFailureHandler(function(error) {
          console.error('Error renaming rack:', error);
          alert('‚ùå Error renaming rack:\n\n' + error.message);
          submitBtn.disabled = false;
          submitBtn.textContent = 'Rename';
        })
        .renameRackConfiguration(currentRenameItemNumber, newItemNumber, newItemName, newDescription);
    }

    // Close modal when clicking outside
    document.addEventListener('DOMContentLoaded', function() {
      var modal = document.getElementById('renameModal');
      if (modal) {
        modal.addEventListener('click', function(e) {
          if (e.target === this) {
            closeRenameDialog();
          }
        });
      }
    });
  </script>
</body>
</html>
